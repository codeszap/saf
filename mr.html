<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>STC Meditation Tracker 1</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
  .table-responsive {
    max-height: 400px;
    overflow-y: auto;
  }
  td, th {
    white-space: nowrap;
  }
</style>
</head>
<body class="bg-light">

<div class="container my-4">
  <h2 class="mb-4">üßò‚Äç‚ôÇÔ∏è Meditation Tracker</h2>

  <!-- Form -->
  <form id="entryForm" class="row g-3">
    <div class="col-md-3">
      <label class="form-label">Date</label>
      <input type="text" id="date" class="form-control" placeholder="dd-mm-yyyy" required>
    </div>
    <div class="col-md-2">
      <label class="form-label">Meditation</label>
      <input type="text" id="meditation" class="form-control" required>
    </div>
    <div class="col-md-2">
      <label class="form-label">Time</label>
      <input type="text" id="time" class="form-control" required>
    </div>
    <div class="col-md-2">
      <label class="form-label">Duration (mins)</label>
      <input type="number" id="duration" class="form-control" required>
    </div>
    <div class="col-md-3">
      <label class="form-label">Notes</label>
      <input type="text" id="notes" class="form-control">
    </div>
    <div class="col-12">
      <button type="submit" class="btn btn-primary">Add Entry</button>
    </div>
  </form>

  <hr>

  <!-- Filter -->
  <div class="row mb-3">
    <div class="col-md-3">
      <label class="form-label fw-semibold">Filter by Month</label>
      <select id="monthFilter" class="form-select">
        <option value="">All Months</option>
        <option value="01">January</option>
        <option value="02">February</option>
        <option value="03">March</option>
        <option value="04">April</option>
        <option value="05">May</option>
        <option value="06">June</option>
        <option value="07">July</option>
        <option value="08">August</option>
        <option value="09">September</option>
        <option value="10">October</option>
        <option value="11">November</option>
        <option value="12">December</option>
      </select>
    </div>
  </div>

  <!-- Table -->
  <div id="snapshotContainer">
    <div class="table-responsive">
      <table class="table table-bordered table-striped" id="meditationTable">
        <thead class="table-dark">
          <tr>
            <th>Date</th>
            <th>Meditation</th>
            <th>Time</th>
            <th>Duration</th>
            <th>Notes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr class="table-secondary fw-bold">
            <td colspan="3">Total</td>
            <td id="totalDuration">0</td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- Buttons -->
  <div class="mt-3">
    <button id="downloadJsonBtn" class="btn btn-success btn-sm">Download JSON</button>
    <button id="downloadImgBtn" class="btn btn-info btn-sm">Download Table Image</button>
    <button id="importJsonBtn" class="btn btn-secondary btn-sm">Import JSON</button>
    <input type="file" id="importFile" accept="application/json" style="display:none">
    <button id="clearAllBtn" class="btn btn-danger btn-sm">Clear All</button>
  </div>
</div>

<script>
const DB_NAME = "MeditationDB";
const DB_VERSION = 1;
const STORE_NAME = "entries";
let db;
let allEntries = [];

window.onload = () => {
  const request = indexedDB.open(DB_NAME, DB_VERSION);
  request.onerror = e => console.error("DB error:", e.target.error);
  request.onsuccess = e => { db = e.target.result; loadEntries(); };
  request.onupgradeneeded = e => {
    db = e.target.result;
    if (!db.objectStoreNames.contains(STORE_NAME)) {
      db.createObjectStore(STORE_NAME, { keyPath: "id", autoIncrement: true });
    }
  };
};

document.getElementById("entryForm").addEventListener("submit", e => {
  e.preventDefault();
  const newEntry = {
    date: date.value.trim(),
    meditation: meditation.value.trim(),
    time: time.value.trim(),
    duration: parseInt(duration.value.trim()) || 0,
    notes: notes.value.trim()
  };
  const tx = db.transaction(STORE_NAME, "readwrite");
  tx.objectStore(STORE_NAME).add(newEntry);
  tx.oncomplete = () => {
    entryForm.reset();
    loadEntries(true);
  };
});

function loadEntries(scrollToLast = false) {
  const tx = db.transaction(STORE_NAME, "readonly");
  const store = tx.objectStore(STORE_NAME);
  const entries = [];
  store.openCursor().onsuccess = e => {
    const cursor = e.target.result;
    if (cursor) { entries.push(cursor.value); cursor.continue(); }
    else {
      entries.sort((a, b) => {
        const [dA, mA, yA] = a.date.split("-");
        const [dB, mB, yB] = b.date.split("-");
        return new Date(`${yA}-${mA}-${dA}`) - new Date(`${yB}-${mB}-${dB}`);
      });
      allEntries = entries;
      applyFilter(scrollToLast);
    }
  };
}

function renderTable(data, scrollToLast) {
  const tbody = document.querySelector("#meditationTable tbody");
  tbody.innerHTML = "";
  let total = 0;

  data.forEach((entry, idx) => {
    total += entry.duration;
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${entry.date}</td>
      <td>${entry.meditation}</td>
      <td>${entry.time}</td>
      <td>${entry.duration}</td>
      <td>${entry.notes}</td>
      <td>
        <button class="btn btn-sm btn-warning me-1" onclick="editEntry(${entry.id})">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteEntry(${entry.id})">Delete</button>
      </td>
    `;
    tbody.appendChild(row);
    if (scrollToLast && idx === data.length - 1) {
      setTimeout(() => row.scrollIntoView({ behavior: "smooth" }), 100);
    }
  });

  document.getElementById("totalDuration").innerText = total;
}

function applyFilter(scrollToLast = false) {
  const monthVal = document.getElementById("monthFilter").value;
  if (!monthVal) renderTable(allEntries, scrollToLast);
  else {
    const filtered = allEntries.filter(e => e.date.split("-")[1] === monthVal);
    renderTable(filtered, scrollToLast);
  }
}

document.getElementById("monthFilter").addEventListener("change", () => applyFilter());

function editEntry(id) {
  const entry = allEntries.find(e => e.id === id);
  if (!entry) return;
  date.value = entry.date;
  meditation.value = entry.meditation;
  time.value = entry.time;
  duration.value = entry.duration;
  notes.value = entry.notes;
  deleteEntry(id, false);
}

function deleteEntry(id, reload = true) {
  const tx = db.transaction(STORE_NAME, "readwrite");
  tx.objectStore(STORE_NAME).delete(id);
  tx.oncomplete = () => { if (reload) loadEntries(); };
}

// JSON download
document.getElementById("downloadJsonBtn").addEventListener("click", () => {
  const displayedData = [];
  document.querySelectorAll("#meditationTable tbody tr").forEach(row => {
    const cells = row.querySelectorAll("td");
    displayedData.push({
      date: cells[0].innerText,
      meditation: cells[1].innerText,
      time: cells[2].innerText,
      duration: parseInt(cells[3].innerText) || 0,
      notes: cells[4].innerText
    });
  });
  const blob = new Blob([JSON.stringify({ form: "stc_meditation", data: displayedData }, null, 2)], { type: "application/json" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "meditation_data.json";
  link.click();
  URL.revokeObjectURL(link.href);
});

// üì∏ Download table as image (full table, Option 1 fix)
document.getElementById('downloadImgBtn').addEventListener('click', () => {
  const tableElement = document.getElementById('meditationTable');
  html2canvas(tableElement, { backgroundColor: "#fff", scale: 2 }).then(canvas => {
    const link = document.createElement('a');
    link.download = 'meditation_table.png';
    link.href = canvas.toDataURL();
    link.click();
  }).catch(err => {
    console.error('Image download failed:', err);
  });
});

// Import JSON
document.getElementById("importJsonBtn").addEventListener("click", () => {
  document.getElementById("importFile").click();
});
document.getElementById("importFile").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = evt => {
    try {
      const json = JSON.parse(evt.target.result);
      if (!json.data) throw new Error("Invalid file");
      const tx = db.transaction(STORE_NAME, "readwrite");
      const store = tx.objectStore(STORE_NAME);
      json.data.forEach(entry => store.add(entry));
      tx.oncomplete = () => loadEntries(true);
    } catch (err) {
      alert("Import failed: " + err.message);
    }
  };
  reader.readAsText(file);
});

// Clear all
document.getElementById("clearAllBtn").addEventListener("click", () => {
  if (!confirm("Are you sure you want to delete all entries?")) return;
  const tx = db.transaction(STORE_NAME, "readwrite");
  tx.objectStore(STORE_NAME).clear();
  tx.oncomplete = () => loadEntries();
});
</script>

</body>
</html>
