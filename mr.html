<!DOCTYPE html>
<html lang="ta">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>STC Meditation Tracker ‚Äî Full</title>
  <link rel="stylesheet" href="css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    /* Fixed height scrollable table body with sticky header */
    .table-responsive {
      max-height: 400px;
      overflow-y: auto;
    }
    #meditationTable th {
      position: sticky;
      top: 0;
      background: #0d6efd;
      color: #fff;
      z-index: 2;
    }
    /* Borders for snapshot clarity */
    #meditationTable, #meditationTable th, #meditationTable td {
      border: 1px solid #dee2e6 !important;
    }
    #meditationTable { border-collapse: collapse !important; }
    /* Custom context menu */
    #contextMenu {
      display: none;
      position: absolute;
      z-index: 1000;
      background: white;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    }
    #contextMenu button {
      display: block;
      width: 100%;
      border: none;
      background: none;
      padding: 8px 12px;
      text-align: left;
    }
    #contextMenu button:hover {
      background: #f0f0f0;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container my-4">
    <h2 class="text-center mb-4">STC Meditation Tracker (Full)</h2>

    <!-- Form -->
    <form id="meditationForm" class="card p-4 shadow rounded mb-3">
      <div class="mb-3">
        <label for="date" class="form-label fw-semibold">Date</label>
        <input type="date" id="date" class="form-control" required />
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold">Meditation</label>
        <div class="form-check form-check-inline">
          <input type="radio" id="medYes" name="meditation" value="yes" class="form-check-input" checked />
          <label for="medYes" class="form-check-label">Yes</label>
        </div>
        <div class="form-check form-check-inline">
          <input type="radio" id="medNo" name="meditation" value="no" class="form-check-input" />
          <label for="medNo" class="form-check-label">No</label>
        </div>
      </div>

      <div class="mb-3">
        <label for="startTime" class="form-label fw-semibold">Start Time</label>
        <input type="time" id="startTime" class="form-control" />
      </div>

      <div class="mb-3">
        <label for="duration" class="form-label fw-semibold">Duration (minutes)</label>
        <input type="number" id="duration" class="form-control" min="1" />
      </div>

      <div class="mb-3">
        <label for="notes" class="form-label fw-semibold">Notes</label>
        <textarea id="notes" rows="3" class="form-control"></textarea>
      </div>

      <div class="d-flex gap-2 flex-wrap justify-content-end">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" id="importBtn" class="btn btn-info">üìÇ Import JSON</button>
        <button type="button" id="exportBtn" class="btn btn-secondary">üíæ Export All JSON</button>
        <button type="button" id="clearAllBtn" class="btn btn-danger">üóëÔ∏è Clear All</button>
        <button type="button" id="downloadImgBtn" class="btn btn-success">üì∏ Download Table</button>
        <button type="button" id="downloadJsonBtn" class="btn btn-warning">üíæ Download Filtered JSON</button>
      </div>
    </form>

    <!-- Month Filter -->
    <div class="mb-3">
      <label class="form-label fw-semibold">Filter by Month</label>
      <select id="monthFilter" class="form-select w-auto">
        <option value="">All Months</option>
        <option value="01">January</option>
        <option value="02">February</option>
        <option value="03">March</option>
        <option value="04">April</option>
        <option value="05">May</option>
        <option value="06">June</option>
        <option value="07">July</option>
        <option value="08">August</option>
        <option value="09">September</option>
        <option value="10">October</option>
        <option value="11">November</option>
        <option value="12">December</option>
      </select>
    </div>

    <!-- Table -->
    <div class="card shadow p-3" id="snapshotContainer">
      <div id="summaryCounts" class="alert alert-info px-4 mb-3" style="display:none;"></div>
      <div class="table-responsive">
        <table class="table table-bordered table-hover table-striped align-middle text-nowrap" id="meditationTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Meditation</th>
              <th>Time</th>
              <th>Duration</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Context menu -->
  <div id="contextMenu">
    <button id="editRowBtn">‚úèÔ∏è Edit</button>
    <button id="deleteRowBtn">üóëÔ∏è Delete</button>
  </div>

  <script>
    const DB_NAME = "MeditationDB";
    const STORE_NAME = "entries";
    let db, allEntries = [], selectedRowId = null;

    const dateInput = document.getElementById('date');
    const timeInput = document.getElementById('startTime');
    const form = document.getElementById('meditationForm');
    const tableBody = document.querySelector('#meditationTable tbody');

    dateInput.valueAsDate = new Date();
    timeInput.value = new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});

    function openDB() {
      const req = indexedDB.open(DB_NAME, 1);
      req.onerror = () => alert("DB error");
      req.onsuccess = e => { db = e.target.result; loadEntries(); };
      req.onupgradeneeded = e => {
        db = e.target.result;
        db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
      };
    }

    function addEntry(entry) {
      const tx = db.transaction(STORE_NAME,'readwrite');
      tx.objectStore(STORE_NAME).add(entry);
      tx.oncomplete = () => { loadEntries(true); form.reset(); dateInput.valueAsDate = new Date(); timeInput.value = new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}); };
    }

    function updateEntry(id, updated) {
      const tx = db.transaction(STORE_NAME,'readwrite');
      tx.objectStore(STORE_NAME).put({...updated, id});
      tx.oncomplete = () => loadEntries();
    }

    function deleteEntry(id) {
      const tx = db.transaction(STORE_NAME,'readwrite');
      tx.objectStore(STORE_NAME).delete(id);
      tx.oncomplete = () => loadEntries();
    }

    function clearAll() {
      if (!confirm("Clear all entries?")) return;
      const tx = db.transaction(STORE_NAME,'readwrite');
      tx.objectStore(STORE_NAME).clear();
      tx.oncomplete = () => loadEntries();
    }

    function loadEntries(scrollToLast=false) {
      const tx = db.transaction(STORE_NAME,'readonly');
      const store = tx.objectStore(STORE_NAME);
      const arr = [];
      store.openCursor().onsuccess = e => {
        const cursor = e.target.result;
        if (cursor) { arr.push(cursor.value); cursor.continue(); }
        else {
          arr.sort((a,b) => {
            const [dA,mA,yA] = a.date.split('-');
            const [dB,mB,yB] = b.date.split('-');
            return new Date(`${yA}-${mA}-${dA}`) - new Date(`${yB}-${mB}-${dB}`);
          });
          allEntries = arr;
          applyFilter(scrollToLast);
        }
      };
    }

    function renderTable(data, scrollToLast=false) {
      tableBody.innerHTML = '';
      data.forEach((entry, i) => {
        const row = document.createElement('tr');
        row.dataset.id = entry.id;
        row.innerHTML = `<td>${entry.date}</td><td>${entry.meditation}</td><td>${entry.time}</td><td>${entry.duration}</td><td>${entry.notes}</td>`;
        tableBody.appendChild(row);
        if (scrollToLast && i === data.length - 1) {
          setTimeout(() => row.scrollIntoView({behavior:"smooth"}), 100);
        }
      });
      const totalDays = new Set(data.map(e=>e.date)).size;
      const yesCount = data.filter(e=>e.meditation==="Yes").length;
      const noCount = data.filter(e=>e.meditation==="No").length;
      const summary = document.getElementById('summaryCounts');
      summary.innerHTML = `<b>Total days:</b> ${totalDays} | <span class="text-success"><b>Yes:</b> ${yesCount}</span> | <span class="text-danger"><b>No:</b> ${noCount}</span>`;
      summary.style.display = 'block';
    }

    function applyFilter(scroll=false) {
      const monthVal = document.getElementById('monthFilter').value;
      let data = allEntries;
      if (monthVal) data = data.filter(e=> e.date.split('-')[1] === monthVal);
      renderTable(data, scroll);
    }

    document.getElementById('monthFilter').addEventListener('change', ()=>applyFilter());

    form.addEventListener('submit', e => {
      e.preventDefault();
      const dateVal = dateInput.value.split('-').reverse().join('-');
      const medVal = document.querySelector('input[name="meditation"]:checked').value === 'yes' ? 'Yes' : 'No';
      let t12='', duration='', notes='';
      if (medVal==="Yes") {
        let [h,m] = timeInput.value.split(':'); h=Number(h);
        t12 = (h%12||12)+':'+m+' '+(h>=12?'PM':'AM');
        duration = document.getElementById('duration').value;
        notes = document.getElementById('notes').value;
      }
      addEntry({date: dateVal, meditation: medVal, time: t12, duration, notes});
    });

    // Context menu
    document.addEventListener('contextmenu', e => {
      if (e.target.closest('#meditationTable tbody tr')) {
        e.preventDefault();
        selectedRowId = Number(e.target.closest('tr').dataset.id);
        const menu = document.getElementById('contextMenu');
        menu.style.top = e.pageY + 'px';
        menu.style.left = e.pageX + 'px';
        menu.style.display = 'block';
      } else {
        document.getElementById('contextMenu').style.display = 'none';
      }
    });
    document.addEventListener('click', ()=>document.getElementById('contextMenu').style.display='none');

    document.getElementById('editRowBtn').addEventListener('click', () => {
      const entry = allEntries.find(e=>e.id===selectedRowId);
      if (!entry) return;
      const [dd,mm,yy] = entry.date.split('-');
      dateInput.value = `${yy}-${mm}-${dd}`;
      if (entry.meditation==="Yes") {
        document.getElementById('medYes').checked = true;
        const parts = entry.time.split(/[: ]/);
        let h = parseInt(parts[0]);
        const m = parts[1];
        if (entry.time.includes('PM') && h<12) h+=12;
        if (entry.time.includes('AM') && h===12) h=0;
        timeInput.value = `${String(h).padStart(2,'0')}:${m}`;
        document.getElementById('duration').value = entry.duration;
        document.getElementById('notes').value = entry.notes;
      } else document.getElementById('medNo').checked = true;
      deleteEntry(selectedRowId);
    });
    document.getElementById('deleteRowBtn').addEventListener('click', () => {
      if (confirm("Delete this entry?")) deleteEntry(selectedRowId);
    });

    document.getElementById('clearAllBtn').addEventListener('click', clearAll);

    // Import JSON
    document.getElementById('importBtn').addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/json';
      input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const imported = JSON.parse(reader.result);
            if (!Array.isArray(imported.data)) throw "Invalid format";
            imported.data.forEach(item=> addEntry(item));
          } catch { alert("Import failed"); }
        };
        reader.readAsText(file);
      };
      input.click();
    });

    // Export all JSON
    document.getElementById('exportBtn').addEventListener('click', () => {
      const payload = {form: 'stc_meditation', data: allEntries};
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'meditation_all.json';
      link.click();
    });

    // Download filtered JSON
    document.getElementById('downloadJsonBtn').addEventListener('click', () => {
      const rows = document.querySelectorAll('#meditationTable tbody tr');
      const filtered = Array.from(rows).map(r=>{
        const cells = r.querySelectorAll('td');
        return {date: cells[0].innerText, meditation: cells[1].innerText, time: cells[2].innerText, duration: cells[3].innerText, notes: cells[4].innerText};
      });
      const payload = {form: 'stc_meditation', data: filtered};
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'meditation_filtered.json';
      link.click();
    });

    // Download table image (filtered view)
    document.getElementById('downloadImgBtn').addEventListener('click', () => {
      html2canvas(document.getElementById('snapshotContainer'), {backgroundColor:'#fff', scale:2})
        .then(canvas=>{
          const link = document.createElement('a');
          link.download = 'meditation_table.png';
          link.href = canvas.toDataURL();
          link.click();
        });
    });

    window.onload = openDB;
  </script>
</body>
</html>
