<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>STC Meditation Tracker 2</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
  body { padding: 20px; }
  table td, table th { vertical-align: middle; }
</style>
</head>
<body>

<h2>Meditation Tracker</h2>

<!-- Top controls -->
<div class="mb-3 d-flex flex-wrap gap-2">
  <input type="month" id="monthFilter" class="form-control w-auto">
  <button id="clearAllBtn" class="btn btn-danger btn-sm">Clear All</button>
  <button id="downloadJsonBtn" class="btn btn-success btn-sm">Download JSON</button>
  <input type="file" id="uploadJsonInput" class="form-control form-control-sm w-auto">
  <button id="downloadImgBtn" class="btn btn-primary btn-sm">Download Image</button>
</div>

<!-- Summary row -->
<div class="mb-2">
  <span class="badge bg-success">Yes: <span id="yesCount">0</span></span>
  <span class="badge bg-danger">No: <span id="noCount">0</span></span>
  <span class="ms-3 fw-bold" id="monthLabel">All Months</span>
</div>

<!-- Table -->
<div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
  <table class="table table-bordered" id="meditationTable">
    <thead class="table-light">
      <tr>
        <th>Date</th>
        <th>Meditation</th>
        <th>Time</th>
        <th>Duration</th>
        <th>Notes</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr class="fw-bold">
        <td colspan="3">Total</td>
        <td id="totalDuration">0</td>
        <td colspan="2"></td>
      </tr>
    </tfoot>
  </table>
</div>

<!-- Form -->
<form id="entryForm" class="mt-3">
  <div class="row g-2">
    <div class="col"><input type="date" id="date" class="form-control" required></div>
    <div class="col"><input type="text" id="meditation" class="form-control" placeholder="Meditation" required></div>
    <div class="col"><input type="time" id="time" class="form-control" required></div>
    <div class="col"><input type="number" id="duration" class="form-control" placeholder="Minutes" required></div>
    <div class="col"><input type="text" id="notes" class="form-control" placeholder="Notes"></div>
    <div class="col"><button type="submit" class="btn btn-primary w-100">Add</button></div>
  </div>
</form>

<script>
// IndexedDB setup
let db;
const request = indexedDB.open("MeditationDB", 1);
request.onupgradeneeded = e => {
  db = e.target.result;
  db.createObjectStore("entries", { keyPath: "id", autoIncrement: true });
};
request.onsuccess = e => {
  db = e.target.result;
  loadEntries();
};
request.onerror = e => console.error("DB error:", e.target.error);

// Load entries
function loadEntries(month = "") {
  const tx = db.transaction("entries", "readonly");
  const store = tx.objectStore("entries");
  const req = store.getAll();
  req.onsuccess = () => {
    let data = req.result;
    if (month) {
      const [y, m] = month.split("-");
      data = data.filter(e => e.date.startsWith(`${y}-${m}`));
    }
    renderTable(data);
  };
}

// Render table + counts
function renderTable(data, scrollToLast) {
  const tbody = document.querySelector("#meditationTable tbody");
  tbody.innerHTML = "";
  let total = 0;
  data.forEach((entry, idx) => {
    total += entry.duration;
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${entry.date}</td>
      <td>${entry.meditation}</td>
      <td>${entry.time}</td>
      <td>${entry.duration}</td>
      <td>${entry.notes}</td>
      <td>
        <button class="btn btn-sm btn-warning me-1" onclick="editEntry(${entry.id})">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteEntry(${entry.id})">Delete</button>
      </td>
    `;
    tbody.appendChild(row);
    if (scrollToLast && idx === data.length - 1) {
      setTimeout(() => row.scrollIntoView({ behavior: "smooth" }), 100);
    }
  });
  document.getElementById("totalDuration").innerText = total;
  updateSummaryAndMonthLabel(data);
}

// Update Yes/No count + month label
function updateSummaryAndMonthLabel(data) {
  let yes = 0, no = 0;
  data.forEach(e => e.duration > 0 ? yes++ : no++);
  document.getElementById("yesCount").innerText = yes;
  document.getElementById("noCount").innerText = no;
  const monthVal = document.getElementById("monthFilter").value;
  const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  document.getElementById("monthLabel").innerText = monthVal
    ? monthNames[parseInt(monthVal.split("-")[1]) - 1]
    : "All Months";
}

// Add entry
document.getElementById("entryForm").addEventListener("submit", e => {
  e.preventDefault();
  const entry = {
    date: date.value,
    meditation: meditation.value,
    time: time.value,
    duration: parseInt(duration.value) || 0,
    notes: notes.value
  };
  const tx = db.transaction("entries", "readwrite");
  tx.objectStore("entries").add(entry);
  tx.oncomplete = () => {
    loadEntries(monthFilter.value);
    e.target.reset();
  };
});

// Edit entry
function editEntry(id) {
  const tx = db.transaction("entries", "readonly");
  const store = tx.objectStore("entries");
  const req = store.get(id);
  req.onsuccess = () => {
    const entry = req.result;
    date.value = entry.date;
    meditation.value = entry.meditation;
    time.value = entry.time;
    duration.value = entry.duration;
    notes.value = entry.notes;
    deleteEntry(id, false);
  };
}

// Delete entry
function deleteEntry(id, reload = true) {
  const tx = db.transaction("entries", "readwrite");
  tx.objectStore("entries").delete(id);
  tx.oncomplete = () => { if (reload) loadEntries(monthFilter.value); };
}

// Clear all
document.getElementById("clearAllBtn").addEventListener("click", () => {
  if (!confirm("Delete all entries?")) return;
  const tx = db.transaction("entries", "readwrite");
  tx.objectStore("entries").clear();
  tx.oncomplete = () => loadEntries(monthFilter.value);
});

// Month filter
document.getElementById("monthFilter").addEventListener("change", e => {
  loadEntries(e.target.value);
});

// JSON download (filtered)
document.getElementById("downloadJsonBtn").addEventListener("click", () => {
  const displayedData = [];
  document.querySelectorAll("#meditationTable tbody tr").forEach(row => {
    const cells = row.querySelectorAll("td");
    displayedData.push({
      date: cells[0].innerText,
      meditation: cells[1].innerText,
      time: cells[2].innerText,
      duration: parseInt(cells[3].innerText) || 0,
      notes: cells[4].innerText
    });
  });
  const blob = new Blob(
    [JSON.stringify({ form: "stc_meditation", data: displayedData }, null, 2)],
    { type: "application/json" }
  );
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "meditation_data.json";
  link.click();
  URL.revokeObjectURL(link.href);
});

// JSON upload
document.getElementById("uploadJsonInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = evt => {
    try {
      const json = JSON.parse(evt.target.result);
      if (!Array.isArray(json.data)) throw new Error("Invalid file");
      const tx = db.transaction("entries", "readwrite");
      const store = tx.objectStore("entries");
      json.data.forEach(item => store.add(item));
      tx.oncomplete = () => loadEntries(monthFilter.value);
    } catch (err) {
      alert("Invalid JSON file");
    }
  };
  reader.readAsText(file);
});

// Image download without actions column
document.getElementById('downloadImgBtn').addEventListener('click', () => {
  const originalTable = document.getElementById('meditationTable');
  const clone = originalTable.cloneNode(true);
  clone.querySelectorAll('tr').forEach(row => {
    if (row.cells.length > 0) {
      row.deleteCell(row.cells.length - 1);
    }
  });
  const tempContainer = document.createElement('div');
  tempContainer.style.backgroundColor = '#fff';
  tempContainer.appendChild(clone);
  document.body.appendChild(tempContainer);
  html2canvas(tempContainer, { scale: 2 }).then(canvas => {
    const link = document.createElement('a');
    link.download = 'meditation_table.png';
    link.href = canvas.toDataURL();
    link.click();
    document.body.removeChild(tempContainer);
  }).catch(err => {
    console.error('Image download failed:', err);
    document.body.removeChild(tempContainer);
  });
});
</script>

</body>
</html>
