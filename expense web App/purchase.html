<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Purchase - Common Drawer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            font-family: 'Plus Jakarta Sans', sans-serif;
            margin: 0;
            padding-bottom: 120px;
        }

        /* Top Bar Style */
        #topBar {
            padding: 15px 20px;
            background: var(--bg-card);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
        }

        .menu-icon {
            font-size: 24px;
            cursor: pointer;
            color: var(--primary-color);
        }

        /* Dashboard Stats */
        .dashboard {
            margin: 15px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .dash-card {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            padding: 12px 8px;
            border-radius: 14px;
            text-align: center;
        }

        .dash-label {
            font-size: 9px;
            font-weight: 800;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dash-val {
            font-size: 15px;
            font-weight: 800;
            color: var(--text-main);
        }

        /* Purchase Cards */
        .items-grid {
            padding: 0 15px;
        }

        .item-row {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }

        .status-btn {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .pending-btn {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary-color);
        }

        .bought-btn {
            background: #2ecc71;
            color: #fff;
        }

        .info {
            flex: 1;
            margin: 0 15px;
        }

        .name {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-main);
        }

        .price-line {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 4px;
        }

        .price {
            font-size: 14px;
            font-weight: 800;
            color: var(--primary-color);
        }

        .date-badge {
            font-size: 10px;
            color: var(--text-muted);
            font-weight: 700;
            background: var(--bg-input);
            padding: 2px 8px;
            border-radius: 6px;
        }

        .bought-row {
            opacity: 0.5;
            filter: grayscale(1);
        }

        /* FAB Button */
        .add-fab {
            position: fixed;
            bottom: 30px;
            right: 25px;
            width: 56px;
            height: 56px;
            background: var(--primary-color);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: none;
            color: white;
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
            z-index: 1000;
        }

        /* Modal Theme */
        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            border-radius: 24px;
        }

        .btn-close-white {
            filter: invert(1);
        }

        [data-theme="light"] .btn-close-white {
            filter: none;
        }

        .form-control {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            border-radius: 12px;
            padding: 12px;
        }

        .form-control:focus {
            background: var(--bg-input);
            color: var(--text-main);
            border-color: var(--primary-color);
            box-shadow: none;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        [data-theme="light"] input[type="date"]::-webkit-calendar-picker-indicator {
            filter: none;
        }

        /* Priority Star */
        .star-box {
            font-size: 18px;
            cursor: pointer;
            color: #ddd;
            transition: 0.2s;
        }

        .star-box.active {
            color: #f1c40f;
        }

        .category-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg-input);
            color: var(--text-muted);
            font-weight: 700;
            text-transform: uppercase;
        }

        /* Searchable Dropdown Styles */
        .searchable-dropdown {
            position: relative;
        }

        .searchable-dropdown .options-list {
            position: absolute;
            top: 110%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1100;
            display: none;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .searchable-dropdown .options-list.show {
            display: block;
        }

        .searchable-dropdown .option-item {
            padding: 10px 15px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-main);
            border-bottom: 1px solid var(--border-color);
        }

        .searchable-dropdown .option-item:last-child {
            border-bottom: none;
        }

        .searchable-dropdown .option-item:hover {
            background: var(--bg-input);
            color: var(--primary-color);
        }

        .searchable-dropdown .option-item.selected {
            background: var(--primary-color);
            color: #fff;
        }
    </style>
</head>

<body>

    <div id="topBar">
        <i class="bi bi-grid-fill menu-icon" onclick="toggleDrawer(true)"></i>
        <h6 class="mb-0 fw-bold">Shopping List</h6>
        <i class="bi bi-trash3 text-danger" onclick="confirmClear()"></i>
    </div>

    <div class="dashboard">
        <div class="dash-card">
            <div class="dash-label">Balance</div>
            <div class="dash-val text-primary" id="availBalance">₹0</div>
        </div>
        <div class="dash-card">
            <div class="dash-label">Selected</div>
            <div class="dash-val" id="totalPrice">₹0</div>
        </div>
        <div class="dash-card">
            <div class="dash-label">Bought</div>
            <div class="dash-val text-success" id="boughtCount">0</div>
        </div>
    </div>

    <!-- Search and Tabs -->
    <div class="px-3 mb-3">
        <div class="input-group mb-3"
            style="border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color);">
            <span class="input-group-text bg-transparent border-0"><i class="bi bi-search text-muted"></i></span>
            <input type="text" id="searchInput" class="form-control border-0 bg-transparent"
                placeholder="Search items..." oninput="handleSearch()">
        </div>

        <ul class="nav nav-pills nav-fill bg-dark-subtle p-1 rounded-4" style="background: var(--bg-input) !important;">
            <li class="nav-item">
                <button class="nav-link active rounded-4 fw-bold py-2 tab-btn" id="tab-pending"
                    onclick="switchTab('pending')">Pending</button>
            </li>
            <li class="nav-item">
                <button class="nav-link rounded-4 fw-bold py-2 tab-btn" id="tab-history"
                    onclick="switchTab('history')">History</button>
            </li>
        </ul>
    </div>

    <div class="items-grid" id="purchaseList"></div>

    <button class="add-fab" onclick="openModal()"><i class="bi bi-plus-lg"></i></button>

    <div class="modal fade" id="itemModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content p-2">
                <div class="modal-header border-0 pb-0">
                    <h5 class="fw-bold" id="modalTitle">Add Item</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editId">

                    <div class="mb-3 d-flex justify-content-between align-items-center bg-light p-2 rounded-3"
                        style="background:var(--bg-input) !important;">
                        <span class="small fw-bold text-muted">PRIORITY (STAR)</span>
                        <i class="bi bi-star-fill star-box" id="itemPriority"
                            onclick="this.classList.toggle('active')"></i>
                    </div>

                    <div class="mb-3">
                        <label class="small text-muted mb-2">Item Name</label>
                        <input type="text" id="itemName" class="form-control" placeholder="E.g., Milk, Battery"
                            list="itemSuggestions">
                        <datalist id="itemSuggestions"></datalist>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-7">
                            <label class="small text-muted mb-2">Category</label>
                            <div class="searchable-dropdown" id="categoryDropdown">
                                <input type="text" class="form-control" id="itemCategoryInput"
                                    placeholder="Select category..." autocomplete="off">
                                <div class="options-list" id="categoryOptions">
                                    <div class="option-item" data-value="GROCERY">GROCERY</div>
                                    <div class="option-item" data-value="ELECTRONICS">ELECTRONICS</div>
                                    <div class="option-item" data-value="FOOD">FOOD</div>
                                    <div class="option-item" data-value="CLOTHES">CLOTHES</div>
                                    <div class="option-item" data-value="PERSONAL">PERSONAL</div>
                                    <div class="option-item" data-value="HOME">HOME</div>
                                    <div class="option-item" data-value="OTHER">OTHER</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-5">
                            <label class="small text-muted mb-2">Price</label>
                            <input type="number" id="itemPrice" class="form-control" placeholder="₹0">
                        </div>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col">
                            <label class="small text-muted mb-2">Account (When Bought)</label>
                            <div class="searchable-dropdown" id="accountDropdown">
                                <input type="text" class="form-control" id="itemAccountInput"
                                    placeholder="Select account..." autocomplete="off">
                                <div class="options-list" id="accountOptions">
                                    <div class="option-item" data-value="BANK">BANK</div>
                                    <div class="option-item" data-value="CASH">CASH</div>
                                    <div class="option-item" data-value="OTHER">OTHER</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-2">
                        <label class="small text-muted mb-2">Target Date</label>
                        <input type="date" id="itemDate" class="form-control">
                    </div>
                    <p class="text-muted" style="font-size:10px;">* Marking as "Bought" will auto-add to Expenses.</p>
                </div>
                <div class="modal-footer border-0 p-3 pt-0">
                    <button class="btn btn-primary w-100 py-3 fw-bold rounded-4 shadow" onclick="saveItem()">SAVE
                        ITEM</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script src="drawer.js"></script>

    <script src="js/firebase-init.js"></script>
    <script>
        const myModal = new bootstrap.Modal(document.getElementById('itemModal'));
        let purchaseData = [];
        let currentTab = 'pending';
        let searchTerm = '';

        async function loadPurchases() {
            try {
                // Initialize suggestions & Balance
                loadTransactionSuggestions();
                loadAvailableBalance();

                const snap = await db.collection("purchase").orderBy("date", "desc").get();
                purchaseData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderItems();
            } catch (e) {
                console.error("Error loading purchases:", e);
                document.getElementById('purchaseList').innerHTML = '<div class="text-center p-5 text-danger">Error loading data</div>';
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            renderItems();
        }

        function handleSearch() {
            searchTerm = document.getElementById('searchInput').value.toLowerCase();
            renderItems();
        }

        function renderItems() {
            let html = "", count = 0;

            // Filter by Tab and Search
            let filtered = purchaseData.filter(t => {
                const matchesTab = currentTab === 'pending' ? !t.isBought : t.isBought;
                const matchesSearch = t.name.toLowerCase().includes(searchTerm) || (t.category && t.category.toLowerCase().includes(searchTerm));
                return matchesTab && matchesSearch;
            });

            // Sort logic: Priorities (Starred) first, then Non-priorities
            const sortedData = filtered.sort((a, b) => {
                if (a.isPriority === b.isPriority) return 0;
                return a.isPriority ? -1 : 1;
            });

            // Update Global Bought Count regardless of filters
            const totalBought = purchaseData.filter(i => i.isBought).length;
            document.getElementById('boughtCount').innerText = totalBought;

            sortedData.forEach(t => {
                const dateStr = new Date(t.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });

                html += `
                <div class="item-row ${t.isBought ? 'bought-row' : ''}">
                    <!-- Select checkbox -->
                    ${!t.isBought ? `
                    <div class="form-check me-2">
                        <input class="form-check-input item-selector" type="checkbox" data-price="${t.price}" ${t.isChecked !== false ? 'checked' : ''} onchange="toggleCheck('${t.id}', ${t.isChecked !== false})">
                    </div>
                    
                    <button class="status-btn pending-btn" onclick="toggleStatus('${t.id}', false)" title="Mark as Bought">
                        <i class="bi bi-cart"></i>
                    </button>
                    ` : ''}
                    
                    <div class="info" onclick="openModal('${t.id}', '${t.name}', ${t.price}, '${t.date}', ${t.isPriority}, '${t.category || ""}', '${t.account || ""}')">
                        <div class="d-flex align-items-center gap-2">
                             <div class="name">${t.name}</div>
                             ${t.isPriority ? '<i class="bi bi-star-fill text-warning" style="font-size:12px;"></i>' : ''}
                        </div>
                        <div class="price-line">
                            <span class="price">₹${t.price}</span>
                            <span class="category-badge">${t.category || "OTHER"}</span>
                            <span class="date-badge">${dateStr}</span>
                        </div>
                    </div>

                    <div class="d-flex align-items-center gap-3">
                        ${t.isBought ? `<i class="bi bi-arrow-counterclockwise text-primary fs-5" style="cursor:pointer;" onclick="toggleStatus('${t.id}', true)" title="Restore to Pending"></i>` : ''}
                        <i class="bi bi-trash text-muted" style="cursor:pointer;" onclick="deleteItem('${t.id}')" title="Delete"></i>
                    </div>
                </div>
            `;
            });

            document.getElementById('purchaseList').innerHTML = html || `<div class="text-center p-5 text-muted">No ${currentTab} items found</div>`;
            calculateSelectedTotal();
        }

        function calculateSelectedTotal() {
            let total = 0;
            const selectors = document.querySelectorAll('.item-selector');
            selectors.forEach(s => {
                if (s.checked) total += Number(s.getAttribute('data-price'));
            });
            document.getElementById('totalPrice').innerText = `₹${total}`;
        }

        function openModal(id = '', name = '', price = '', date = '', isPriority = false, category = 'OTHER', account = 'BANK') {
            document.getElementById('modalTitle').innerText = id ? 'Edit Item' : 'New Purchase';
            document.getElementById('editId').value = id;
            document.getElementById('itemName').value = name;
            document.getElementById('itemPrice').value = price;
            document.getElementById('itemDate').value = date ? date.split('T')[0] : new Date().toISOString().split('T')[0];

            // Set Searchable Dropdown Values
            document.getElementById('itemCategoryInput').value = category || 'OTHER';
            document.getElementById('itemAccountInput').value = account || 'BANK';

            const star = document.getElementById('itemPriority');
            if (isPriority) star.classList.add('active');
            else star.classList.remove('active');

            myModal.show();
        }

        async function saveItem() {
            const id = document.getElementById('editId').value;
            const name = document.getElementById('itemName').value;
            const price = document.getElementById('itemPrice').value;
            const date = document.getElementById('itemDate').value;
            const category = document.getElementById('itemCategoryInput').value;
            const account = document.getElementById('itemAccountInput').value;
            const isPriority = document.getElementById('itemPriority').classList.contains('active');

            if (!name || !price) return;

            const data = {
                name,
                price: Number(price),
                date: new Date(date).toISOString(),
                category,
                account,
                isPriority
            };

            if (id) await db.collection("purchase").doc(id).update(data);
            else await db.collection("purchase").add({ ...data, isBought: false, isChecked: true });

            myModal.hide(); loadPurchases();
        }

        async function toggleStatus(id, current) {
            const item = purchaseData.find(i => i.id === id);
            if (!item) return;

            const newStatus = !current;
            const updateData = {
                isBought: newStatus,
                isChecked: !newStatus // Auto uncheck if bought, check if moved back to pending
            };

            if (newStatus === true) {
                const transactionData = {
                    amount: Number(item.price),
                    category: item.category || "OTHER",
                    description: `PURCHASE: ${item.name}`,
                    account: item.account || "BANK",
                    date: new Date().toISOString().split('T')[0],
                    type: "Expense",
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    const txRef = await db.collection("transactions").add(transactionData);
                    updateData.lastTransactionId = txRef.id;
                    console.log("Auto-added expense to transactions");
                } catch (e) {
                    console.error("Auto-add failed:", e);
                }
            } else {
                // RESTORING: Delete associated transaction if exists
                if (item.lastTransactionId) {
                    try {
                        await db.collection("transactions").doc(item.lastTransactionId).delete();
                        updateData.lastTransactionId = firebase.firestore.FieldValue.delete();
                        console.log("Auto-deleted associated transaction");
                    } catch (e) {
                        console.error("Auto-delete transaction failed:", e);
                    }
                }
            }

            await db.collection("purchase").doc(id).update(updateData);
            if (!newStatus) {
                location.reload();
            } else {
                loadPurchases();
            }
        }

        async function toggleCheck(id, current) {
            await db.collection("purchase").doc(id).update({ isChecked: !current });
            loadPurchases();
        }

        async function deleteItem(id) {
            if (confirm("Remove?")) { await db.collection("purchase").doc(id).delete(); loadPurchases(); }
        }

        async function confirmClear() {
            if (confirm("Clear all items?")) {
                const snap = await db.collection("purchase").get();
                const batch = db.batch();
                snap.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                loadPurchases();
            }
        }

        async function loadTransactionSuggestions() {
            try {
                const snap = await db.collection("transactions").get();
                const descriptions = new Set();
                const categories = new Set();
                const accounts = new Set();

                snap.forEach(doc => {
                    const data = doc.data();
                    if (data.description) {
                        // Strip "PURCHASE: " prefix if exists
                        let desc = data.description.replace(/^PURCHASE: /i, '');
                        descriptions.add(desc);
                    }
                    if (data.category) categories.add(data.category);
                    if (data.account) accounts.add(data.account);
                });

                // Populate Name Suggestions
                const datalist = document.getElementById('itemSuggestions');
                datalist.innerHTML = Array.from(descriptions).map(d => `<option value="${d}">`).join('');

                // Populate Category Suggestions
                const categoryOptions = document.getElementById('categoryOptions');
                const existingCats = Array.from(categoryOptions.querySelectorAll('.option-item')).map(o => o.getAttribute('data-value'));
                categories.forEach(cat => {
                    if (cat && !existingCats.includes(cat)) {
                        const div = document.createElement('div');
                        div.className = 'option-item';
                        div.setAttribute('data-value', cat);
                        div.innerText = cat;
                        categoryOptions.appendChild(div);
                    }
                });

                // Populate Account Suggestions
                const accountOptions = document.getElementById('accountOptions');
                const existingAccs = Array.from(accountOptions.querySelectorAll('.option-item')).map(o => o.getAttribute('data-value'));
                accounts.forEach(acc => {
                    if (acc && !existingAccs.includes(acc)) {
                        const div = document.createElement('div');
                        div.className = 'option-item';
                        div.setAttribute('data-value', acc);
                        div.innerText = acc;
                        accountOptions.appendChild(div);
                    }
                });

                // Re-initialize searchable logic for new items
                initSearchableDropdowns();

            } catch (e) {
                console.error("Error loading transaction suggestions:", e);
            }
        }

        function initSearchableDropdowns() {
            const dropdowns = document.querySelectorAll('.searchable-dropdown');

            dropdowns.forEach(dropdown => {
                const input = dropdown.querySelector('input');
                const list = dropdown.querySelector('.options-list');
                const items = list.querySelectorAll('.option-item');

                // Clear previous listeners to avoid duplicates
                const newInput = input.cloneNode(true);
                input.parentNode.replaceChild(newInput, input);

                newInput.addEventListener('focus', () => {
                    list.classList.add('show');
                });

                newInput.addEventListener('input', () => {
                    const filter = newInput.value.toLowerCase();
                    items.forEach(item => {
                        const text = item.innerText.toLowerCase();
                        item.style.display = text.includes(filter) ? 'block' : 'none';
                    });
                    list.classList.add('show');
                });

                items.forEach(item => {
                    item.addEventListener('click', () => {
                        newInput.value = item.getAttribute('data-value');
                        list.classList.remove('show');
                    });
                });
            });
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.searchable-dropdown')) {
                document.querySelectorAll('.options-list').forEach(l => l.classList.remove('show'));
            }
        });

        async function loadAvailableBalance() {
            try {
                const snap = await db.collection("transactions").get();
                let bank = 0, cash = 0, others = 0;
                snap.forEach(doc => {
                    const t = doc.data();
                    const amt = parseFloat(t.amount) || 0;
                    const acc = (t.account || "OTHERS").toUpperCase();
                    if (t.type === "Income") {
                        if (acc === "BANK") bank += amt; else if (acc === "CASH") cash += amt; else others += amt;
                    } else if (t.type === "Expense") {
                        if (acc === "BANK") bank -= amt; else if (acc === "CASH") cash -= amt; else others -= amt;
                    } else if (t.type === "Transfer") {
                        const toAcc = (t.toAccount || "").toUpperCase();
                        if (acc === "BANK") bank -= amt; else if (acc === "CASH") cash -= amt; else others -= amt;
                        if (toAcc === "BANK") bank += amt; else if (toAcc === "CASH") cash += amt; else others += amt;
                    }
                });
                const total = bank + cash + others;
                document.getElementById('availBalance').innerText = `₹${total.toLocaleString('en-IN')}`;
            } catch (e) {
                console.error("Error loading balance:", e);
            }
        }

        window.onload = loadPurchases;
    </script>
</body>

</html>