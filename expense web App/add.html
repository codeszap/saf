<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Add/Edit Transaction</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/theme.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600&display=swap');

        body {
            background: var(--bg-main);
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text-main);
        }

        .card {
            border-radius: 15px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
        }

        .card-body {
            background: var(--bg-card);
            border-radius: 15px;
        }

        .form-label {
            font-size: 11px;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            color: var(--text-muted) !important;
        }

        .form-control,
        .form-select {
            border-radius: 8px;
            padding: 10px;
            font-size: 14px;
            background: var(--bg-input);
            color: var(--text-main);
            border: 1px solid var(--border-color);
        }

        .form-control:focus,
        .form-select:focus {
            background: var(--bg-input);
            color: var(--text-main);
            border-color: var(--primary-color);
            box-shadow: none;
        }

        .btn-light {
            background: var(--bg-input);
            color: var(--text-main);
            border: 1px solid var(--border-color);
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        [data-theme="light"] input[type="date"]::-webkit-calendar-picker-indicator {
            filter: none;
        }

        /* Autocomplete Styles */
        .autocomplete-items {
            position: absolute;
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-top: none;
            z-index: 1050;
            /* Above most things */
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            max-height: 200px;
            overflow-y: auto;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-main);
            font-size: 14px;
        }

        .autocomplete-item:hover,
        .autocomplete-active {
            background-color: var(--bg-input);
        }

        .voice-fab {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
            z-index: 2000;
            border: none;
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .voice-fab.listening {
            transform: scale(1.1);
            animation: voicePulse 1.5s infinite;
        }

        @keyframes voicePulse {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }

            70% {
                box-shadow: 0 0 0 20px rgba(59, 130, 246, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }

        #voiceStatusOverlay {
            position: fixed;
            bottom: 175px;
            right: 20px;
            background: var(--bg-card);
            padding: 10px 18px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            display: none;
            z-index: 2000;
            max-width: 250px;
        }
    </style>
</head>

<body>

    <div class="container py-3" style="max-width:420px">
        <div class="d-flex align-items-center mb-3">
            <a href="javascript:history.back()" class="btn btn-light btn-sm me-2 border">← Back</a>
            <h6 class="mb-0 fw-bold" id="formTitle">Add Transaction</h6>
        </div>

        <div class="card shadow-sm border-0">
            <div class="card-body">
                <form id="transactionForm" autocomplete="off">
                    <div class="mb-3">
                        <label class="form-label fw-bold text-muted">DATE</label>
                        <input type="date" name="date" class="form-control" id="dateInput" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold text-muted">TYPE</label>
                        <select name="type" id="typeSelect" class="form-select fw-bold" required>
                            <option value="Expense" selected>EXPENSE</option>
                            <option value="Income">INCOME</option>
                            <option value="Transfer">TRANSFER (⇆)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold text-muted d-flex justify-content-between">
                            <span>AMOUNT (₹)</span>
                            <span id="calcHint" class="text-primary small" style="opacity:0.7">Supports 10+5
                                format</span>
                        </label>
                        <div class="input-group">
                            <input type="text" name="amount" id="amountInput" class="form-control fw-bold fs-5"
                                placeholder="0.00" required inputmode="decimal">
                        </div>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col">
                            <label class="form-label fw-bold text-muted" id="fromAccLabel">ACCOUNT</label>
                            <select name="account" class="form-select" required>
                                <option value="BANK" selected>BANK</option>
                                <option value="CASH">CASH</option>
                                <option value="OTHER">OTHER</option>
                            </select>
                        </div>
                        <div class="col d-none" id="toAccountDiv">
                            <label class="form-label fw-bold text-primary">TO ACCOUNT</label>
                            <select name="toAccount" class="form-select border-primary">
                                <option value="CASH">CASH</option>
                                <option value="BANK">BANK</option>
                                <option value="OTHER">OTHER</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3 position-relative">
                        <label class="form-label fw-bold text-muted">CATEGORY</label>
                        <input type="text" name="category" id="categoryInput" class="form-control"
                            placeholder="E.g., FOOD, RENT" required autocomplete="off">
                    </div>

                    <div class="mb-3 position-relative">
                        <label class="form-label fw-bold text-muted">DESCRIPTION (OPTIONAL)</label>
                        <input type="text" name="description" id="descriptionInput" class="form-control"
                            placeholder="Details..." autocomplete="off">
                    </div>

                    <div class="row g-2 mt-4">
                        <div class="col-6">
                            <button type="button" class="btn btn-outline-primary w-100 py-2 fw-bold"
                                id="saveAddMoreBtn">
                                + SAVE MORE
                            </button>
                        </div>
                        <div class="col-6">
                            <button type="submit" class="btn btn-primary w-100 py-2 fw-bold shadow-sm" id="saveButton">
                                SAVE & CLOSE
                            </button>
                        </div>
                    </div>
                </form>
                <div id="statusMsg" class="text-center mt-3 d-none fw-bold text-success" style="font-size: 13px;">✅
                    Transaction Saved</div>
            </div>
        </div>
    </div>

    <!-- Floating Voice Button -->
    <button type="button" id="voiceFab" class="voice-fab">
        <i class="bi bi-mic-fill"></i>
    </button>
    <div id="voiceStatusOverlay">Listening...</div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="bottom-nav.js"></script>
    <script src="js/firebase-init.js"></script>
    <script>
        const transactionsCol = db.collection('transactions');
        const form = document.getElementById("transactionForm");
        const typeSelect = document.getElementById("typeSelect");
        const toAccountDiv = document.getElementById("toAccountDiv");
        const fromAccLabel = document.getElementById("fromAccLabel");
        const saveAddMoreBtn = document.getElementById("saveAddMoreBtn");
        const statusMsg = document.getElementById("statusMsg");

        // Logic to show/hide To Account for Transfers
        typeSelect.addEventListener("change", (e) => {
            if (e.target.value === "Transfer") {
                toAccountDiv.classList.remove("d-none");
                fromAccLabel.innerText = "FROM";
                form.toAccount.required = true;
            } else {
                toAccountDiv.classList.add("d-none");
                fromAccLabel.innerText = "ACCOUNT";
                form.toAccount.required = false;
            }
        });

        const today = new Date().toISOString().split('T')[0];
        document.getElementById("dateInput").value = today;

        const params = new URLSearchParams(window.location.search);
        let isEditMode = false;
        let docId = params.get('id');

        if (docId) {
            isEditMode = true;
            document.getElementById("formTitle").textContent = "Edit Transaction";
            // Note: saveButton is defined below, let's ensure it exists
            const saveBtn = document.getElementById("saveButton");
            saveBtn.textContent = "Update Transaction";

            transactionsCol.doc(docId).get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    form.date.value = data.date;
                    form.type.value = data.type;
                    form.amount.value = data.amount;
                    form.account.value = data.account;
                    form.category.value = data.category || "";
                    form.description.value = data.description || "";

                    if (data.type === "Transfer") {
                        typeSelect.dispatchEvent(new Event('change'));
                        form.toAccount.value = data.toAccount;
                    }
                }
            });
        } else {
            const duplicateId = params.get('duplicate');
            if (duplicateId) {
                document.getElementById("formTitle").textContent = "Duplicate Transaction";
                transactionsCol.doc(duplicateId).get().then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        // Keep today's date for duplicate
                        form.type.value = data.type;
                        form.amount.value = data.amount;
                        form.account.value = data.account;
                        form.category.value = data.category || "";
                        form.description.value = data.description || "";

                        if (data.type === "Transfer") {
                            typeSelect.dispatchEvent(new Event('change'));
                            form.toAccount.value = data.toAccount;
                        }
                    }
                });
            }
        }

        const amountInput = document.getElementById("amountInput");
        const voiceFab = document.getElementById("voiceFab");
        const voiceStatusOverlay = document.getElementById("voiceStatusOverlay");

        // --- Mini Calculator Logic ---
        function evaluateExpression(str) {
            try {
                // Basic cleanup: remove everything except numbers and + - * / . ( )
                let cleaned = str.replace(/[^0-9+\-*/.()]/g, '');
                if (!cleaned) return null;
                // Use Function constructor instead of eval for a bit more safety in a controlled env
                let result = new Function(`return ${cleaned}`)();
                return isFinite(result) ? parseFloat(result.toFixed(2)) : null;
            } catch (e) {
                return null;
            }
        }

        amountInput.addEventListener("blur", function () {
            let result = evaluateExpression(this.value);
            if (result !== null && this.value.includesAny(['+', '-', '*', '/'])) {
                this.value = result;
            }
        });

        // Helper for includesAny
        String.prototype.includesAny = function (arr) {
            return arr.some(v => this.includes(v));
        };

        // --- Advanced Voice Input Logic ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            voiceFab.style.display = "none";
        } else {
            const recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            let isListening = false;

            voiceFab.addEventListener("click", () => {
                if (isListening) {
                    recognition.stop();
                } else {
                    try {
                        recognition.start();
                    } catch (e) {
                        recognition.stop();
                    }
                }
            });

            recognition.onstart = () => {
                isListening = true;
                voiceFab.classList.add("listening");
                voiceStatusOverlay.style.display = "block";
                voiceStatusOverlay.innerText = "Listening...";
            };

            recognition.onresult = (event) => {
                isListening = false;
                const text = event.results[0][0].transcript.toLowerCase();
                voiceStatusOverlay.innerText = `Heard: "${text}"`;

                // --- SMART PARSING ---
                // 1. TYPE
                const types = ["expense", "income", "transfer"];
                const foundType = types.find(t => text.includes(t));
                if (foundType) {
                    form.type.value = foundType.charAt(0).toUpperCase() + foundType.slice(1);
                    typeSelect.dispatchEvent(new Event('change'));
                }

                // 2. AMOUNT
                const amountMatch = text.match(/\d+/);
                if (amountMatch) {
                    amountInput.value = amountMatch[0];
                }

                // 3. ACCOUNT (Detect Bank/Cash)
                const accounts = ["bank", "cash", "other"];
                const words = text.split(" ");
                let accountFoundCount = 0;

                words.forEach((word, idx) => {
                    const found = accounts.find(a => word.includes(a));
                    if (found) {
                        accountFoundCount++;
                        if (accountFoundCount === 1) {
                            form.account.value = found.toUpperCase();
                        } else if (accountFoundCount === 2 && form.type.value === "Transfer") {
                            form.toAccount.value = found.toUpperCase();
                        }
                    }
                });

                // 4. CATEGORY (Everything else that isn't a keyword)
                let categoryText = text;
                [...types, ...accounts, ...(amountMatch ? [amountMatch[0]] : []), "from", "to", "for", "account"].forEach(kw => {
                    categoryText = categoryText.replace(new RegExp(`\\b${kw}\\b`, 'g'), "");
                });

                const finalCategory = categoryText.trim().replace(/\s+/g, " ");
                if (finalCategory) {
                    document.getElementById("categoryInput").value = finalCategory.toUpperCase();
                }

                setTimeout(() => {
                    if (!isListening) voiceStatusOverlay.style.display = "none";
                }, 3000);
            };

            recognition.onerror = () => {
                isListening = false;
                voiceStatusOverlay.innerText = "Error! Try again.";
                setTimeout(() => {
                    if (!isListening) voiceStatusOverlay.style.display = "none";
                }, 2000);
            };

            recognition.onend = () => {
                isListening = false;
                voiceFab.classList.remove("listening");
            };
        }

        // Helper to show success message briefly
        function showStatus() {
            statusMsg.classList.remove("d-none");
            setTimeout(() => statusMsg.classList.add("d-none"), 2000);
        }

        // Helper to reset form but keep Date and Account (for speed)
        function resetForm() {
            amountInput.value = "";
            form.category.value = "";
            form.description.value = "";
            amountInput.focus();
            saveButton.disabled = false;
            saveAddMoreBtn.disabled = false;
            saveButton.textContent = isEditMode ? "Update Transaction" : "SAVE & CLOSE";
            saveAddMoreBtn.textContent = "+ SAVE MORE";
            voiceStatus.innerText = 'Click to speak (e.g., "Food 150")';
        }

        async function handleSave(stayOnPage = false) {
            // First check if amount needs evaluation
            let finalAmt = evaluateExpression(amountInput.value);
            if (finalAmt === null) finalAmt = parseFloat(amountInput.value);

            if (!finalAmt || finalAmt <= 0) return alert("Enter valid amount");
            if (!form.category.value.trim()) return alert("Category is required");

            const transactionData = {
                date: form.date.value,
                type: form.type.value,
                amount: finalAmt,
                account: form.account.value,
                category: form.category.value.trim().toUpperCase(),
                description: form.description.value.trim().toUpperCase(),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (form.type.value === "Transfer") {
                transactionData.toAccount = form.toAccount.value;
            }

            saveButton.disabled = true;
            saveAddMoreBtn.disabled = true;
            const originalBtnText = stayOnPage ? saveAddMoreBtn.textContent : saveButton.textContent;

            if (stayOnPage) saveAddMoreBtn.textContent = "Saving...";
            else saveButton.textContent = "Saving...";

            try {
                if (isEditMode) {
                    await transactionsCol.doc(docId).update(transactionData);
                } else {
                    await transactionsCol.add(transactionData);
                }

                if (stayOnPage) {
                    showStatus();
                    resetForm();
                    loadSuggestions(); // Reload suggestions for autocomplete
                } else {
                    window.location.href = "index.html";
                }
            } catch (err) {
                alert("Error: " + err);
                saveButton.disabled = false;
                saveAddMoreBtn.disabled = false;
                if (stayOnPage) saveAddMoreBtn.textContent = originalBtnText;
                else saveButton.textContent = originalBtnText;
            }
        }

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            await handleSave(false);
        });

        saveAddMoreBtn.addEventListener("click", async () => {
            await handleSave(true);
        });

        // --- Custom Autocomplete Logic ---

        function autocomplete(inp, arr) {
            let currentFocus;

            inp.addEventListener("input", function (e) {
                let a, b, i, val = this.value;
                closeAllLists();
                if (!val) { return false; }
                currentFocus = -1;

                a = document.createElement("DIV");
                a.setAttribute("id", this.id + "autocomplete-list");
                a.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(a);

                for (i = 0; i < arr.length; i++) {
                    // Match logic: Check if parts of string match? Or just includes?
                    // User wants suggestion when typing. Let's do case-insensitive includes
                    if (arr[i].toUpperCase().includes(val.toUpperCase())) {
                        b = document.createElement("DIV");
                        b.className = "autocomplete-item";
                        // Highlight matching part?? Too complex for now, just show text
                        b.innerHTML = arr[i];
                        b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                        b.addEventListener("click", function (e) {
                            inp.value = this.getElementsByTagName("input")[0].value;
                            closeAllLists();
                        });
                        a.appendChild(b);
                    }
                }
            });

            // Add support for seeing all options on focus if empty? 
            // Or maybe just top 10 recent? Let's stick to typing for now as list might be huge.
            // Actually user said "when typing suggestion should come".

            function closeAllLists(elmnt) {
                var x = document.getElementsByClassName("autocomplete-items");
                for (var i = 0; i < x.length; i++) {
                    if (elmnt != x[i] && elmnt != inp) {
                        x[i].parentNode.removeChild(x[i]);
                    }
                }
            }

            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });
        }

        async function loadSuggestions() {
            try {
                // Limit to recent 200 to keep it fast
                const snapshot = await transactionsCol.orderBy('date', 'desc').limit(200).get();
                const categories = new Set();
                const descriptions = new Set();

                snapshot.forEach(doc => {
                    const d = doc.data();
                    if (d.category) categories.add(d.category);
                    if (d.description) descriptions.add(d.description);
                });

                // Init Autocomplete
                autocomplete(document.getElementById("categoryInput"), [...categories].sort());
                autocomplete(document.getElementById("descriptionInput"), [...descriptions].sort());

            } catch (e) { console.error("Error loading suggestions", e); }
        }

        loadSuggestions();
    </script>
    <script src="bottom-nav.js"></script>
</body>

</html>