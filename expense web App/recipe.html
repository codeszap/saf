<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Recipe Planner - ProCheck</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/theme.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg-main);
            color: var(--text-main);
            padding-bottom: 20px;
            overflow-x: hidden;
            transition: background 0.3s, color 0.3s;
        }

        .recipe-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 10px 15px;
        }

        .hidden {
            display: none !important;
        }

        /* Glass Header (Themed) */
        .glass-header {
            background: var(--bg-card);
            border: var(--card-border);
            border-radius: 12px;
            padding: 10px 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            position: sticky;
            top: 10px;
            z-index: 1000;
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        /* Search Input */
        .search-box {
            flex-grow: 1;
            position: relative;
        }

        #searchInput {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px 8px 38px;
            width: 100%;
            font-size: 0.95rem;
            color: var(--text-main);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1rem;
        }

        /* List Group Box & Swipe Styles */
        .list-group-box {
            background: var(--bg-card);
            border: var(--card-border);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px var(--shadow-color);
            margin-bottom: 20px;
        }

        .list-item-wrapper {
            position: relative;
            overflow: hidden;
            background: var(--bg-input);
            border-bottom: 1px solid var(--border-color);
        }

        .list-item-wrapper:last-child {
            border-bottom: none;
        }

        .swipe-actions {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            display: flex;
            align-items: center;
            padding: 0 10px;
            z-index: 1;
        }

        .swipe-btn {
            height: 40px;
            width: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            border: none;
            color: #fff;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-today {
            background: #28a745;
        }

        .btn-tomorrow {
            background: #ffc107;
            color: #000;
        }

        .btn-pick {
            background: #007bff;
        }

        .list-item {
            display: flex;
            align-items: center;
            padding: 14px 18px;
            cursor: pointer;
            background: var(--bg-card);
            transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28), background 0.2s;
            position: relative;
            z-index: 2;
        }

        .list-item.swiped {
            transform: translateX(-160px);
        }

        .list-item:hover {
            background: var(--bg-input);
        }

        /* Recipe Dashboard Content */
        .recipe-item-content {
            flex-grow: 1;
            min-width: 0;
            margin-right: 15px;
        }

        .item-title {
            font-weight: 700;
            font-size: 1.05rem;
            margin-bottom: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-stats {
            display: flex;
            gap: 10px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .item-total {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 0.95rem;
            flex-shrink: 0;
            margin-right: 10px;
        }

        .drag-handle {
            cursor: grab;
            color: var(--text-muted);
            padding: 5px 10px 5px 0;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        /* Ingredient List Specifics */
        .custom-checkbox {
            width: 22px;
            height: 22px;
            border-radius: 6px;
            border: 2px solid var(--border-color);
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: 0.2s;
        }

        .list-item.checked .custom-checkbox {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .list-item.checked .custom-checkbox::after {
            content: "\f26b";
            font-family: Bootstrap-icons;
            color: #fff;
            font-size: 14px;
        }

        .list-item.checked .item-title {
            color: var(--text-muted);
            text-decoration: line-through;
            opacity: 0.7;
        }

        /* FAB */
        .fab {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 1.8rem;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
            border: none;
            z-index: 1001;
            transition: transform 0.2s;
        }

        .fab:active {
            transform: scale(0.9);
        }

        .action-icon {
            color: var(--text-muted);
            font-size: 1.1rem;
            transition: color 0.2s;
            padding: 5px;
        }

        .action-icon:hover {
            color: var(--primary-color);
        }

        .action-icon.text-danger:hover {
            color: #dc3545;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        /* Modal & General Polish */
        .modal-content {
            border-radius: 12px;
            border: none;
            background: var(--bg-card);
            color: var(--text-main);
        }

        .modal-header {
            border-bottom: none;
            padding: 25px 25px 10px;
        }

        .modal-footer {
            border-top: none;
            padding: 10px 25px 25px;
        }

        .modern-input {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 18px;
            color: var(--text-main);
            width: 100%;
            margin-bottom: 15px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 5px 15px;
        }

        .section-header-title {
            font-size: 0.8rem;
            font-weight: 800;
            text-transform: uppercase;
            color: var(--text-muted);
        }
    </style>
</head>

<body data-theme="light">

    <div class="recipe-container">

        <!-- DASHBOARD VIEW -->
        <div id="dashboardView">
            <header class="glass-header">
                <i class="bi bi-grid-fill fs-4 text-primary" style="cursor: pointer;" onclick="toggleDrawer(true)"></i>
                <div class="search-box">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" id="searchInput" placeholder="Search dishes..." oninput="handleSearch()">
                </div>
                <i class="bi bi-bar-chart-fill fs-4 text-primary" style="cursor: pointer;"
                    onclick="openStatsModal()"></i>
            </header>

            <div id="recipeHistoryContainer">
                <!-- Grouped History rendered here -->
            </div>

            <div id="listEmptyState" class="empty-state hidden">
                <i class="bi bi-journal-text fs-1 mb-3 d-block"></i>
                <h6>No Recipes Found</h6>
                <p class="small">Tap + to add a dish</p>
            </div>

            <button class="fab" onclick="createNewRecipe()">
                <i class="bi bi-plus-lg"></i>
            </button>
        </div>

        <!-- EDITOR VIEW -->
        <div id="editorView" class="hidden">
            <header class="glass-header">
                <i class="bi bi-arrow-left fs-4" style="cursor: pointer;" onclick="showDashboard()"></i>
                <div id="activeDishTitle" class="fw-bold"
                    style="flex-grow:1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-left:10px;">
                    Recipe Editor</div>
                <div class="badge bg-primary rounded-pill py-2 px-3">
                    <span style="font-size: 0.7rem;">₹</span><span id="currentTotalCost">0</span>
                </div>
            </header>

            <div class="section-header">
                <span class="section-header-title">Ingredients Checklist</span>
                <button class="btn btn-sm btn-outline-secondary rounded-pill px-3" style="font-size: 0.75rem;"
                    onclick="openRenameModal()">Rename</button>
            </div>

            <div id="ingredientListBox" class="list-group-box"></div>

            <div id="editorEmptyState" class="empty-state hidden">
                <i class="bi bi-basket3 fs-2 d-block mb-3"></i>
                <p class="small">No items yet.<br>Tap the + button to add ingredients.</p>
            </div>

            <div class="mt-4 text-center">
                <button class="btn btn-link text-danger text-decoration-none btn-sm" onclick="deleteCurrentRecipe()">
                    <i class="bi bi-trash3 me-1"></i>Delete Dish
                </button>
            </div>

            <button class="fab" onclick="openAddIngredientModal()">
                <i class="bi bi-plus-lg"></i>
            </button>
        </div>

        <!-- REPORT VIEW (Full Screen) -->
        <div id="reportView" class="hidden">
            <header class="glass-header">
                <i class="bi bi-arrow-left fs-4" style="cursor: pointer;" onclick="showDashboard()"></i>
                <div class="fw-bold" style="flex-grow:1; margin-left:10px;">Overall Report</div>
                <i class="bi bi-grid-fill fs-4 text-primary" style="cursor: pointer;" onclick="toggleDrawer(true)"></i>
            </header>

            <!-- Tabs in Page -->
            <ul class="nav nav-pills w-100 bg-light-subtle rounded-pill p-1 mb-3" id="reportTabs" role="tablist"
                style="border: 1px solid var(--border-color);">
                <li class="nav-item flex-fill" role="presentation">
                    <button class="nav-link active rounded-pill py-2 w-100 small fw-bold" id="summary-tab"
                        data-bs-toggle="pill" data-bs-target="#summaryPane" type="button">SUMMARY</button>
                </li>
                <li class="nav-item flex-fill" role="presentation">
                    <button class="nav-link rounded-pill py-2 w-100 small fw-bold" id="timeline-tab"
                        data-bs-toggle="pill" data-bs-target="#timelinePane" type="button"
                        onclick="renderTimeline()">TIMELINE</button>
                </li>
            </ul>

            <div class="tab-content" id="reportTabContent">
                <div class="tab-pane fade show active" id="summaryPane" role="tabpanel">
                    <div id="reportStatsList" class="mt-2">
                        <!-- Stats rows -->
                    </div>
                </div>
                <div class="tab-pane fade" id="timelinePane" role="tabpanel">
                    <div id="reportTimelineList" class="mt-2">
                        <!-- History rows -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Add/Edit Ingredient -->
    <div class="modal fade" id="ingredientModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="ingModalTitle">Add Ingredients</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="addFeedback" class="text-success small fw-bold mb-2 hidden"><i
                            class="bi bi-check-circle-fill me-1"></i>Item added!</div>
                    <input type="text" id="ingName" class="modern-input" placeholder="Item Name">
                    <input type="number" id="ingPrice" class="modern-input" placeholder="Price (Optional ₹)">
                    <textarea id="ingDesc" class="modern-input" placeholder="Description / Notes (Optional)"
                        rows="2"></textarea>

                    <div id="modalPreviewSection" class="mt-3 hidden">
                        <div class="small fw-bold text-muted mb-2 border-top pt-2">Recently Added:</div>
                        <div id="modalPreviewList" class="small"></div>
                    </div>
                </div>
                <div class="modal-footer flex-column" id="ingModalFooter"></div>
            </div>
        </div>
    </div>

    <!-- MODAL: Rename Dish -->
    <div class="modal fade" id="renameDishModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Rename Dish</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="dishNameInput" class="modern-input" placeholder="New Dish Name">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary w-100 rounded-pill py-2 fw-bold"
                        onclick="saveNewName()">SAVE CHANGES</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Ingredient Detail -->
    <div class="modal fade" id="ingDetailModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title fw-bold" id="detailModalTitle">Ingredient Name</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-0">
                    <div id="detailModalPrice" class="text-primary fw-bold mb-3"></div>
                    <div id="detailModalDesc" class="text-muted small" style="line-height: 1.6;"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Hidden Date Picker for Swipe -->
    <input type="date" id="hiddenDatePicker" class="hidden" onchange="assignCustomDate(this.value)">

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="drawer.js"></script>
    <script src="js/firebase-init.js"></script>
    <script>
        let recipes = [];
        let currentRecipeId = null;
        let currentEditIngredientId = null;
        let currentSwipeRecipeId = null;
        let searchTerm = "";

        const ingModal = new bootstrap.Modal(document.getElementById('ingredientModal'));
        const renameModal = new bootstrap.Modal(document.getElementById('renameDishModal'));
        const detailModal = new bootstrap.Modal(document.getElementById('ingDetailModal'));

        let sortableInstance = null;

        // Load & Migrate Data
        async function initApp() {
            // 1. Load from Firebase
            try {
                const snap = await db.collection("recipes").orderBy("date", "desc").get();
                recipes = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // 2. Initial Migration (Local -> Firebase)
                const localData = JSON.parse(localStorage.getItem('saved_recipes')) || [];
                if (localData.length > 0) {
                    console.log("Migrating local data to Firebase...");
                    for (const rec of localData) {
                        // Check if already exists by a simple match logic (or just dump if empty)
                        if (!recipes.some(r => r.name === rec.name && r.date === rec.date)) {
                            const newDoc = await db.collection("recipes").add({
                                name: rec.name,
                                ingredients: rec.ingredients,
                                date: rec.date
                            });
                            recipes.unshift({ id: newDoc.id, name: rec.name, ingredients: rec.ingredients, date: rec.date });
                        }
                    }
                    localStorage.removeItem('saved_recipes'); // Done migration
                }

                renderDashboard();
            } catch (e) {
                console.error("Firebase init error:", e);
                // Fallback to local if Firebase fails? No, user want Firebase.
                document.getElementById('dashboardView').innerHTML += `<div class="alert alert-danger m-3">Cloud Storage Error. Check Connection.</div>`;
            }
        }

        initApp();

        async function saveData() {
            // Local fallback for smooth UI? Let's just rely on async Firebase for now
            // In a real app we'd hide the "Saving..." indicator
        }

        function handleSearch() {
            searchTerm = document.getElementById('searchInput').value.toLowerCase();
            renderDashboard();
        }

        function openStatsModal() {
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('editorView').classList.add('hidden');
            document.getElementById('reportView').classList.remove('hidden');

            // Switch to summary tab by default
            const summaryTab = document.getElementById('summary-tab');
            bootstrap.Tab.getInstance(summaryTab)?.show() || new bootstrap.Tab(summaryTab).show();

            const statsList = document.getElementById('reportStatsList');
            statsList.innerHTML = "";

            // Calculate Stats
            const dishStats = {};
            recipes.forEach(r => {
                const name = r.name.trim();
                const date = r.date ? r.date.split('T')[0] : null;
                if (!dishStats[name]) {
                    dishStats[name] = { count: 0, dates: [], weeks: new Set() };
                }
                dishStats[name].count++;
                if (date) {
                    dishStats[name].dates.push(date);
                    const d = new Date(date);
                    const week = `${d.getFullYear()}-W${getWeekNumber(d)}`;
                    dishStats[name].weeks.add(week);
                }
            });

            const sortedStats = Object.entries(dishStats).sort((a, b) => b[1].count - a[1].count);

            if (sortedStats.length === 0) {
                statsList.innerHTML = "<p class='text-center text-muted py-4'>No data yet.</p>";
            } else {
                sortedStats.forEach(([name, data]) => {
                    const div = document.createElement('div');
                    div.className = "p-3 mb-2 rounded-3 border bg-light-subtle";
                    div.style.cursor = "pointer";
                    div.onclick = (e) => {
                        const detail = div.querySelector('.stats-detail');
                        detail.classList.toggle('hidden');
                    };

                    const sortedDates = data.dates.sort((a, b) => b.localeCompare(a));
                    const dateTags = sortedDates.map(d => `<span class="badge bg-secondary-subtle text-secondary border me-1 mb-1" style="font-size: 0.7rem;">${new Date(d).toLocaleDateString('en-IN', { day: '2-digit', month: 'short' })}</span>`).join('');

                    div.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-bold text-primary">${name}</div>
                                <div class="small text-muted">${data.weeks.size} Unique Weeks</div>
                            </div>
                            <div class="badge bg-primary rounded-pill px-3 py-2">${data.count} Times</div>
                        </div>
                        <div class="stats-detail hidden mt-3 pt-2 border-top">
                            <div class="small fw-bold text-muted mb-2">Previous Dates:</div>
                            <div class="d-flex flex-wrap">${dateTags}</div>
                        </div>
                    `;
                    statsList.appendChild(div);
                });
            }
        }

        function renderTimeline() {
            const list = document.getElementById('reportTimelineList');
            list.innerHTML = "";

            if (recipes.length === 0) {
                list.innerHTML = "<p class='text-center text-muted py-4'>No history yet.</p>";
                return;
            }

            // Group by Month
            const months = {};
            const sortedRecipes = [...recipes].sort((a, b) => {
                const dA = a.date ? new Date(a.date) : new Date(0);
                const dB = b.date ? new Date(b.date) : new Date(0);
                return dB - dA;
            });

            sortedRecipes.forEach(r => {
                const d = r.date ? new Date(r.date) : null;
                const monthKey = d ? d.toLocaleDateString('en-IN', { month: 'long', year: 'numeric' }).toUpperCase() : 'UNKNOWN';
                if (!months[monthKey]) months[monthKey] = [];
                months[monthKey].push(r);
            });

            Object.entries(months).forEach(([month, items]) => {
                const header = document.createElement('div');
                header.className = "small fw-bold text-muted mb-2 mt-3 px-2";
                header.innerText = month;
                list.appendChild(header);

                const box = document.createElement('div');
                box.className = "list-group-box mb-3";
                box.style.borderWidth = "1px";

                items.forEach(r => {
                    const d = r.date ? new Date(r.date) : null;
                    const dateDisplay = d ? d.toLocaleDateString('en-IN', { day: '2-digit', month: 'short' }) : '??';
                    const total = (r.ingredients || []).reduce((acc, curr) => acc + (curr.checked ? (parseFloat(curr.price) || 0) : 0), 0);

                    const row = document.createElement('div');
                    row.className = "d-flex justify-content-between align-items-center p-3 border-bottom border-light";
                    row.innerHTML = `
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-light text-dark border p-2" style="font-size: 0.65rem; min-width: 45px;">${dateDisplay}</span>
                            <span class="fw-bold small text-truncate" style="max-width: 140px;">${r.name}</span>
                        </div>
                        <span class="text-primary fw-bold small text-nowrap">₹${total.toLocaleString('en-IN')}</span>
                    `;
                    box.appendChild(row);
                });
                list.appendChild(box);
            });
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }

        function renderDashboard() {
            const container = document.getElementById('recipeHistoryContainer');
            const empty = document.getElementById('listEmptyState');
            container.innerHTML = "";

            const filtered = recipes.filter(r => r.name.toLowerCase().includes(searchTerm));
            if (filtered.length === 0) {
                empty.classList.remove('hidden'); return;
            }
            empty.classList.add('hidden');

            // Group by Date
            const groups = {};
            filtered.forEach(r => {
                const dateKey = r.date ? r.date.split('T')[0] : 'Unknown';
                if (!groups[dateKey]) groups[dateKey] = [];
                groups[dateKey].push(r);
            });

            const sortedDates = Object.keys(groups).sort((a, b) => b.localeCompare(a));

            sortedDates.forEach(dateStr => {
                const header = document.createElement('div');
                header.className = "section-header mt-3";

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const d = dateStr !== 'Unknown' ? new Date(dateStr) : null;
                if (d) d.setHours(0, 0, 0, 0);

                let displayDate = dateStr;
                let relativeLabel = "";

                if (dateStr === 'Unknown') {
                    displayDate = "Unknown Date";
                } else if (d) {
                    const diffTime = d.getTime() - today.getTime();
                    const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays === 0) displayDate = "Today";
                    else if (diffDays === 1) displayDate = "Tomorrow";
                    else if (diffDays === -1) displayDate = "Yesterday";
                    else displayDate = d.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });

                    if (diffDays > 0) relativeLabel = ` (In ${diffDays} day${diffDays > 1 ? 's' : ''})`;
                    else if (diffDays < 0) relativeLabel = ` (${Math.abs(diffDays)} day${Math.abs(diffDays) > 1 ? 's' : ''} ago)`;
                }

                header.innerHTML = `
                    <span class="section-header-title">${displayDate}${relativeLabel}</span>
                `;
                container.appendChild(header);

                const box = document.createElement('div');
                box.className = "list-group-box";

                groups[dateStr].forEach(r => {
                    const total = (r.ingredients || []).reduce((acc, curr) => acc + (curr.checked ? (parseFloat(curr.price) || 0) : 0), 0);
                    const wrapper = document.createElement('div');
                    wrapper.className = "list-item-wrapper";
                    wrapper.innerHTML = `
                        <div class="swipe-actions">
                            <button class="swipe-btn btn-today" onclick="assignToday(event, '${r.id}')">T</button>
                            <button class="swipe-btn btn-tomorrow" onclick="assignTomorrow(event, '${r.id}')">W</button>
                            <button class="swipe-btn btn-pick" onclick="triggerDatePicker(event, '${r.id}')"><i class="bi bi-calendar-event"></i></button>
                        </div>
                        <div class="list-item" id="recipe-${r.id}" 
                             onclick="openRecipeDetail('${r.id}')"
                             ontouchstart="handleTouchStart(event, '${r.id}')"
                             ontouchmove="handleTouchMove(event)"
                             ontouchend="handleTouchEnd(event)">
                            <div class="recipe-item-content">
                                <div class="item-title">${r.name}</div>
                                <div class="item-stats"><span>${(r.ingredients || []).length} items</span></div>
                            </div>
                            <div class="item-total">₹${total.toLocaleString('en-IN')}</div>
                            <i class="bi bi-trash3 action-icon text-danger" onclick="deleteRecipeDirect(event, '${r.id}')"></i>
                        </div>
                    `;
                    box.appendChild(wrapper);
                });
                container.appendChild(box);
            });
        }

        // SWIPE LOGIC
        let touchStartX = 0;
        let touchMoveX = 0;
        let activeSwipeElement = null;

        function handleTouchStart(e, id) {
            touchStartX = e.touches[0].clientX;
            activeSwipeElement = document.getElementById('recipe-' + id);
            // Close any other open swipes
            document.querySelectorAll('.list-item.swiped').forEach(el => {
                if (el !== activeSwipeElement) el.classList.remove('swiped');
            });
        }

        function handleTouchMove(e) {
            touchMoveX = e.touches[0].clientX;
            const diff = touchStartX - touchMoveX;
            if (activeSwipeElement && diff > 20) {
                // Potential swipe left
            }
        }

        function handleTouchEnd(e) {
            const diff = touchStartX - e.changedTouches[0].clientX;
            if (diff > 100) activeSwipeElement.classList.add('swiped');
            else if (diff < -50) activeSwipeElement.classList.remove('swiped');
        }

        // Assignment Actions
        async function assignToday(e, id) {
            e.stopPropagation();
            const r = recipes.find(rec => rec.id === id);
            r.date = new Date().toISOString();
            await db.collection("recipes").doc(id).update({ date: r.date });
            renderDashboard();
        }

        async function assignTomorrow(e, id) {
            e.stopPropagation();
            const r = recipes.find(rec => rec.id === id);
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            r.date = tomorrow.toISOString();
            await db.collection("recipes").doc(id).update({ date: r.date });
            renderDashboard();
        }

        function triggerDatePicker(e, id) {
            e.stopPropagation();
            currentSwipeRecipeId = id;
            document.getElementById('hiddenDatePicker').showPicker();
        }

        async function assignCustomDate(val) {
            if (!val) return;
            const r = recipes.find(rec => rec.id === currentSwipeRecipeId);
            r.date = new Date(val).toISOString();
            await db.collection("recipes").doc(currentSwipeRecipeId).update({ date: r.date });
            renderDashboard();
        }

        // Existing functions...
        async function deleteRecipeDirect(e, id) {
            e.stopPropagation(); if (!confirm("Delete?")) return;
            await db.collection("recipes").doc(id).delete();
            recipes = recipes.filter(r => r.id !== id);
            renderDashboard();
        }

        async function createNewRecipe() {
            const data = { name: "New Dish", ingredients: [], date: new Date().toISOString() };
            const doc = await db.collection("recipes").add(data);
            recipes.unshift({ id: doc.id, ...data });
            openRecipeDetail(doc.id); openRenameModal();
        }

        function openRecipeDetail(id) {
            currentRecipeId = id; const r = recipes.find(rec => rec.id === id);
            document.getElementById('activeDishTitle').innerText = r.name;
            renderIngredients();
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('editorView').classList.remove('hidden');
        }

        async function showDashboard() {
            // Cleanup: remove any recipes with 0 ingredients
            const toDelete = recipes.filter(r => !r.ingredients || r.ingredients.length === 0);
            for (const r of toDelete) {
                await db.collection("recipes").doc(r.id).delete();
            }
            recipes = recipes.filter(r => r.ingredients && r.ingredients.length > 0);

            renderDashboard();
            document.getElementById('dashboardView').classList.remove('hidden');
            document.getElementById('editorView').classList.add('hidden');
            document.getElementById('reportView').classList.add('hidden');
        }

        function openRenameModal() {
            const r = recipes.find(rec => rec.id === currentRecipeId);
            const input = document.getElementById('dishNameInput');
            input.value = r.name;
            renameModal.show();
            setTimeout(() => {
                input.focus();
                input.select();
            }, 500);
        }
        async function saveNewName() {
            const n = document.getElementById('dishNameInput').value.trim();
            if (!n) return;
            const r = recipes.find(rec => rec.id === currentRecipeId);
            r.name = n;
            await db.collection("recipes").doc(currentRecipeId).update({ name: n });
            document.getElementById('activeDishTitle').innerText = n;
            renameModal.hide();
        }

        function openAddIngredientModal() {
            currentEditIngredientId = null;
            document.getElementById('ingModalTitle').innerText = "Add Ingredients";
            document.getElementById('ingName').value = "";
            document.getElementById('ingPrice').value = "";
            document.getElementById('ingDesc').value = "";
            document.getElementById('addFeedback').classList.add('hidden');
            document.getElementById('modalPreviewSection').classList.add('hidden');
            document.getElementById('modalPreviewList').innerHTML = "";

            document.getElementById('ingModalFooter').innerHTML = `
                <button class="btn btn-primary w-100 rounded-pill mb-2" onclick="addIngredient()">ADD ITEM</button>
                <button class="btn btn-light w-100 rounded-pill text-muted" data-bs-dismiss="modal">DONE</button>`;
            ingModal.show(); setTimeout(() => document.getElementById('ingName').focus(), 500);
        }

        function renderModalPreview() {
            const recipe = recipes.find(rec => rec.id === currentRecipeId);
            const list = document.getElementById('modalPreviewList');
            const section = document.getElementById('modalPreviewSection');

            if (!recipe || recipe.ingredients.length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');
            const lastItems = recipe.ingredients.slice(-5).reverse();
            list.innerHTML = lastItems.map(i => `
                <div class="d-flex justify-content-between align-items-center py-1 border-bottom border-light">
                    <span class="text-truncate" style="max-width: 150px;">${i.name}</span>
                    <span class="text-muted">₹${(i.price || 0).toFixed(0)}</span>
                </div>
            `).join('');
        }

        function openEditIngredientModal(e, id) {
            e.stopPropagation(); currentEditIngredientId = id;
            const r = recipes.find(rec => rec.id === currentRecipeId);
            const i = r.ingredients.find(item => item.id === id);
            document.getElementById('ingModalTitle').innerText = "Edit Ingredient";
            document.getElementById('ingName').value = i.name;
            document.getElementById('ingPrice').value = i.price || "";
            document.getElementById('ingDesc').value = i.desc || "";
            document.getElementById('ingModalFooter').innerHTML = `<button class="btn btn-primary w-100 rounded-pill" onclick="updateIngredient()">SAVE</button>`;
            ingModal.show();
        }

        function viewIngredientDetail(e, id) {
            e.stopPropagation();
            const r = recipes.find(rec => rec.id === currentRecipeId);
            const i = r.ingredients.find(item => item.id === id);
            document.getElementById('detailModalTitle').innerText = i.name;
            document.getElementById('detailModalPrice').innerText = i.price > 0 ? `₹${i.price.toLocaleString('en-IN')}` : '';
            document.getElementById('detailModalDesc').innerText = i.desc || "No additional description added.";
            detailModal.show();
        }

        async function addIngredient() {
            const n = document.getElementById('ingName').value.trim();
            const p = parseFloat(document.getElementById('ingPrice').value) || 0;
            const d = document.getElementById('ingDesc').value.trim();
            if (!n) return;
            const r = recipes.find(r => r.id === currentRecipeId);
            r.ingredients.push({ id: Date.now(), name: n, price: p, desc: d, checked: false });
            await db.collection("recipes").doc(currentRecipeId).update({ ingredients: r.ingredients });
            renderIngredients();
            renderModalPreview();

            const f = document.getElementById('addFeedback'); f.classList.remove('hidden');
            document.getElementById('ingName').value = ""; document.getElementById('ingPrice').value = ""; document.getElementById('ingDesc').value = ""; document.getElementById('ingName').focus();
            setTimeout(() => f.classList.add('hidden'), 1500);
        }

        async function updateIngredient() {
            const n = document.getElementById('ingName').value.trim();
            const p = parseFloat(document.getElementById('ingPrice').value) || 0;
            const d = document.getElementById('ingDesc').value.trim();
            const r = recipes.find(rec => rec.id === currentRecipeId);
            const i = r.ingredients.find(item => item.id === currentEditIngredientId);
            i.name = n; i.price = p; i.desc = d;
            await db.collection("recipes").doc(currentRecipeId).update({ ingredients: r.ingredients });
            renderIngredients(); ingModal.hide();
        }

        async function toggleIngredient(id) {
            const r = recipes.find(rec => rec.id === currentRecipeId);
            const i = r.ingredients.find(item => item.id === id);
            i.checked = !i.checked;
            await db.collection("recipes").doc(currentRecipeId).update({ ingredients: r.ingredients });
            renderIngredients();
        }

        async function deleteRecipeItem(e, id) {
            e.stopPropagation(); if (!confirm("Delete item?")) return;
            const r = recipes.find(rec => rec.id === currentRecipeId);
            r.ingredients = r.ingredients.filter(i => i.id !== id);
            await db.collection("recipes").doc(currentRecipeId).update({ ingredients: r.ingredients });
            renderIngredients();
        }

        async function deleteCurrentRecipe() {
            if (!confirm("Delete dish?")) return;
            await db.collection("recipes").doc(currentRecipeId).delete();
            recipes = recipes.filter(r => r.id !== currentRecipeId);
            showDashboard();
        }

        function renderIngredients() {
            const r = recipes.find(rec => rec.id === currentRecipeId);
            const box = document.getElementById('ingredientListBox');
            const empty = document.getElementById('editorEmptyState');
            let total = 0; box.innerHTML = "";
            if (!r || r.ingredients.length === 0) { empty.classList.remove('hidden'); } else {
                empty.classList.add('hidden');
                r.ingredients.forEach(i => {
                    const pr = parseFloat(i.price) || 0; if (i.checked) total += pr;
                    const d = document.createElement('div');
                    d.className = `list-item ${i.checked ? 'checked' : ''}`;
                    d.setAttribute('data-id', i.id);
                    d.innerHTML = `
                        <div class="drag-handle"><i class="bi bi-grip-vertical"></i></div>
                        <div class="custom-checkbox" onclick="event.stopPropagation(); toggleIngredient(${i.id})"></div>
                        <div class="recipe-item-content" onclick="viewIngredientDetail(event, ${i.id})">
                            <div class="item-title">${i.name}</div>
                            ${pr > 0 ? `<div class="small text-muted">₹${pr.toFixed(0)}</div>` : ''}
                        </div>
                        <div class="item-actions">
                            <i class="bi bi-pencil-square action-icon" onclick="openEditIngredientModal(event, ${i.id})"></i>
                            <i class="bi bi-x-circle action-icon text-danger" onclick="deleteRecipeItem(event, ${i.id})"></i>
                        </div>`;
                    box.appendChild(d);
                });
            }
            document.getElementById('currentTotalCost').innerText = total.toLocaleString('en-IN');
            initSortable();
        }

        function initSortable() {
            const box = document.getElementById('ingredientListBox');
            if (sortableInstance) sortableInstance.destroy();
            sortableInstance = new Sortable(box, {
                handle: '.drag-handle',
                animation: 150,
                onEnd: async function () {
                    const r = recipes.find(rec => rec.id === currentRecipeId);
                    const newOrder = Array.from(box.children).map(child => parseInt(child.getAttribute('data-id')));
                    r.ingredients = newOrder.map(id => r.ingredients.find(ing => ing.id === id));
                    await db.collection("recipes").doc(currentRecipeId).update({ ingredients: r.ingredients });
                }
            });
        }
    </script>

</html>