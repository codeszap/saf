<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Transactions - Pro Search</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');

        body {
            background: var(--bg-main);
            color: var(--text-main);
            overflow-x: hidden;
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: background 0.3s, color 0.3s;
        }

        #overlayLoader {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(3px);
        }

        #topBar {
            position: sticky;
            top: 0;
            z-index: 1001;
            background: var(--bg-card);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        /* Search Box with Clear Button */
        .search-wrapper {
            flex-grow: 1;
            margin: 0 10px;
            position: relative;
        }

        #searchInput {
            border-radius: 20px;
            padding-left: 35px;
            padding-right: 35px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            font-size: 14px;
            text-transform: uppercase;
        }

        #searchInput:focus {
            border-color: var(--primary-color);
            box-shadow: none;
        }

        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 14px;
        }

        #clearSearchBtn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            cursor: pointer;
            display: none;
            font-size: 16px;
        }

        #balanceSummary {
            position: sticky;
            top: 52px;
            z-index: 1000;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            padding: 10px 15px;
            box-shadow: 0 4px 6px -1px var(--shadow-color);
        }

        .compact-stat {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .swipe-container {
            position: relative;
            overflow: hidden;
            background: var(--bg-card);
            touch-action: pan-y;
            margin-bottom: 1px;
        }

        .swipe-actions {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            display: flex;
            visibility: hidden;
        }

        .swipe-actions button {
            width: 65px;
            border: none;
            color: #fff;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-edit {
            background: var(--primary-color);
        }

        .btn-delete {
            background: #dc3545;
        }

        .swipe-content {
            width: 100%;
            background: var(--bg-card);
            transition: transform .25s ease;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-main);
        }

        .date-header {
            background: var(--bg-input);
            padding: 6px 15px;
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-color);
        }

        .day-total-in {
            color: #198754;
            margin-right: 8px;
        }

        .day-total-out {
            color: #dc3545;
        }

        #addBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 54px;
            height: 54px;
            font-size: 24px;
            border-radius: 50%;
            z-index: 1002;
            box-shadow: 0 5px 15px rgba(13, 110, 253, 0.4);
            border: none;
            background: var(--primary-color);
            color: #fff;
        }
    </style>
</head>

<body>

    <div id="overlayLoader">
        <div class="spinner-border text-primary"></div>
    </div>

    <div class="container px-0" style="max-width:450px">
        <div id="topBar">
            <i class="bi bi-grid-fill fs-5 text-primary" onclick="toggleDrawer(true)"></i>
            <div class="search-wrapper">
                <i class="bi bi-search search-icon"></i>
                <input type="text" id="searchInput" class="form-control form-control-sm"
                    placeholder="SEARCH CAT, AMT, DESC..." oninput="handleSearch()">
                <i class="bi bi-x-circle-fill" id="clearSearchBtn" onclick="clearSearch()"></i>
            </div>
            <i class="bi bi-bar-chart-line fs-5 text-dark" onclick="window.location.href='summary.html'"></i>
        </div>

        <div id="balanceSummary">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <div class="compact-stat">Available Balance</div>
                    <div class="h4 fw-bold mb-0" id="sumNetBalance">₹0.00</div>
                </div>
                <div class="text-end">
                    <div class="d-flex gap-3">
                        <div>
                            <div class="compact-stat text-success">Income</div>
                            <div class="text-success fw-bold" id="sumIncome">₹0</div>
                        </div>
                        <div>
                            <div class="compact-stat text-danger">Expense</div>
                            <div class="text-danger fw-bold" id="sumExpense">₹0</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row g-0 pt-2 border-top text-center" id="accountBreakdown" style="font-size: 10px;"></div>
        </div>

        <div id="transactionList" class="pb-5"></div>
        <button id="loadMoreBtn" class="btn btn-light btn-sm w-100 py-2 text-primary fw-bold"
            onclick="loadTransactions(true)" style="display:none; border-radius:0;">LOAD OLDER</button>
    </div>

    <button onclick="window.location.href='add.html'" class="btn btn-primary" id="addBtn"><i
            class="bi bi-plus"></i></button>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="drawer.js"></script>
    <script src="bottom-nav.js"></script>
    <script src="js/firebase-init.js"></script>

    <script>
        const overlay = document.getElementById("overlayLoader");
        const list = document.getElementById("transactionList");
        const loadMoreBtn = document.getElementById("loadMoreBtn");
        const clearBtn = document.getElementById("clearSearchBtn");
        let lastVisible = null;
        let allData = [];

        async function fetchAllData() {
            const snap = await db.collection("transactions").orderBy("date", "desc").get();
            allData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        // Search handle with Clear Button Toggle
        function handleSearch() {
            const term = document.getElementById("searchInput").value.toUpperCase();

            // Clear button toggle logic
            clearBtn.style.display = term.length > 0 ? "block" : "none";

            if (term.length === 0) {
                loadTransactions();
                return;
            }
            const filtered = allData.filter(t => {
                const cat = (t.category || "").toUpperCase();
                const desc = (t.description || "").toUpperCase();
                const amt = (t.amount || "").toString();
                return cat.includes(term) || desc.includes(term) || amt.includes(term);
            });
            renderListFromData(filtered);
            loadMoreBtn.style.display = "none";
        }

        // Clear Function
        function clearSearch() {
            document.getElementById("searchInput").value = "";
            clearBtn.style.display = "none";
            loadTransactions();
        }

        function renderListFromData(dataArray) {
            list.innerHTML = "";
            if (dataArray.length === 0) {
                list.innerHTML = "<div class='text-center p-5 text-muted'>No results found.</div>";
                return;
            }

            const grouped = {};
            dataArray.forEach(t => {
                const key = new Date(t.date).toDateString();
                if (!grouped[key]) {
                    grouped[key] = { items: [], income: 0, expense: 0 };
                }
                grouped[key].items.push(t);
                const amt = parseFloat(t.amount) || 0;
                if (t.type === "Income") grouped[key].income += amt;
                else if (t.type === "Expense") grouped[key].expense += amt;
            });

            Object.keys(grouped).forEach(dateStr => {
                const group = grouped[dateStr];
                const dayWrap = document.createElement("div");
                dayWrap.innerHTML = `
                <div class="date-header d-flex justify-content-between align-items-center">
                    <span>${new Date(dateStr).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })}</span>
                    <div style="font-size: 9px; font-weight: 800;">
                        <span class="day-total-in">IN: ₹${group.income.toFixed(0)}</span>
                        <span class="day-total-out">OUT: ₹${group.expense.toFixed(0)}</span>
                    </div>
                </div>`;
                list.appendChild(dayWrap);

                group.items.forEach(t => {
                    const row = document.createElement("div");
                    row.className = "swipe-container";
                    const isInc = t.type === "Income";
                    const isTrf = t.type === "Transfer";
                    row.innerHTML = `
                    <div class="swipe-actions">
                        <button class="btn-edit" onclick="window.location.href='add.html?id=${t.id}'">Edit</button>
                        <button class="btn-delete" onclick="deleteTx('${t.id}')">Del</button>
                    </div>
                    <div class="swipe-content d-flex justify-content-between align-items-center px-3 py-2">
                        <div style="max-width: 70%;">
                            <div class="fw-bold" style="font-size: 13px;">${t.category}</div>
                            <div class="text-muted" style="font-size: 10px;">${t.account}${isTrf ? ' → ' + t.toAccount : ''} • ${t.description || ''}</div>
                        </div>
                        <div class="${isInc ? 'text-success' : (isTrf ? 'text-primary' : 'text-danger')} fw-bold" style="font-size: 14px;">
                            ${isInc ? '+' : (isTrf ? '⇆' : '-')}₹${parseFloat(t.amount).toFixed(2)}
                        </div>
                    </div>`;
                    dayWrap.appendChild(row);
                    enableSwipe(row);
                });
            });
        }

        async function loadTransactions(isMore = false) {
            overlay.style.display = "flex";
            try {
                if (!isMore) { await fetchAllData(); await updateGlobalSummary(); }
                let query = db.collection("transactions").orderBy("date", "desc").limit(50);
                if (isMore && lastVisible) query = query.startAfter(lastVisible);
                else list.innerHTML = "";
                const snap = await query.get();
                if (snap.empty) { loadMoreBtn.style.display = "none"; overlay.style.display = "none"; return; }
                lastVisible = snap.docs[snap.docs.length - 1];
                const currentData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderListFromData(currentData);
                loadMoreBtn.style.display = snap.docs.length === 50 ? "block" : "none";
            } catch (e) { console.error(e); }
            overlay.style.display = "none";
        }

        async function updateGlobalSummary() {
            let bank = 0, cash = 0, others = 0, inc = 0, exp = 0;
            allData.forEach(t => {
                const amt = parseFloat(t.amount) || 0;
                const acc = (t.account || "OTHERS").toUpperCase();
                if (t.type === "Income") { inc += amt; if (acc === "BANK") bank += amt; else if (acc === "CASH") cash += amt; else others += amt; }
                else if (t.type === "Expense") { exp += amt; if (acc === "BANK") bank -= amt; else if (acc === "CASH") cash -= amt; else others -= amt; }
                else if (t.type === "Transfer") {
                    const toAcc = (t.toAccount || "").toUpperCase();
                    if (acc === "BANK") bank -= amt; else if (acc === "CASH") cash -= amt; else others -= amt;
                    if (toAcc === "BANK") bank += amt; else if (toAcc === "CASH") cash += amt; else others += amt;
                }
            });
            document.getElementById("sumIncome").innerText = `₹${inc.toFixed(0)}`;
            document.getElementById("sumExpense").innerText = `₹${exp.toFixed(0)}`;
            document.getElementById("sumNetBalance").innerText = `₹${(bank + cash + others).toLocaleString('en-IN')}`;
            document.getElementById("accountBreakdown").innerHTML = `<div class="col-4 border-end">BANK: <b>₹${bank.toFixed(0)}</b></div><div class="col-4 border-end">CASH: <b>₹${cash.toFixed(0)}</b></div><div class="col-4">OTHERS: <b>₹${others.toFixed(0)}</b></div>`;
        }

        function enableSwipe(row) {
            const content = row.querySelector(".swipe-content");
            const actions = row.querySelector(".swipe-actions");
            let startX = 0, moveX = 0;
            content.addEventListener("touchstart", e => { startX = e.touches[0].clientX; actions.style.visibility = "visible"; }, { passive: true });
            content.addEventListener("touchmove", e => {
                moveX = e.touches[0].clientX - startX;
                if (moveX < 0) content.style.transform = `translateX(${Math.max(moveX, -130)}px)`;
            });
            content.addEventListener("touchend", () => {
                if (moveX < -60) content.style.transform = "translateX(-130px)";
                else { content.style.transform = "translateX(0)"; actions.style.visibility = "hidden"; }
                moveX = 0;
            });
        }

        async function deleteTx(id) {
            if (confirm("Delete?")) { await db.collection("transactions").doc(id).delete(); location.reload(); }
        }

        loadTransactions();
    </script>
</body>

</html>