<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Transactions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    #overlayLoader {
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.5);
      display:flex; align-items:center; justify-content:center;
      z-index:9999; display:none;
    }
  </style>
</head>
<body class="bg-light">

<!-- Overlay Loader -->
<div id="overlayLoader">
  <div class="text-center text-white">
    <div class="spinner-border text-light" style="width:3rem;height:3rem"></div>
    <div class="mt-2">Loading transactions...</div>
  </div>
</div>

<div class="container py-3" style="max-width:420px">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0 fw-bold">Transactions</h5>
  </div>

  <!-- Transactions list -->
  <div id="transactionList"></div>
</div>

<!-- Floating Add Button -->
<a href="add.html" class="btn btn-success rounded-circle position-fixed bottom-0 end-0 m-3 shadow">+</a>

<!-- Action Modal -->
<div class="modal fade" id="actionModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <h6>Select action</h6>
      <button id="editBtn" class="btn btn-primary w-100 mb-2">Edit</button>
      <button id="deleteBtn" class="btn btn-danger w-100">Delete</button>
      <button class="btn btn-secondary w-100 mt-2" data-bs-dismiss="modal">Cancel</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxkuaCmPHJfIaEwudHRQakcvOy8aiv5jDeq8uT8Ma-k0aQkg6wgHOTTN1pDK0YnON6Wlw/exec"; // replace with your Apps Script URL
const DELETE_URL = "https://script.google.com/macros/s/AKfycbxkuaCmPHJfIaEwudHRQakcvOy8aiv5jDeq8uT8Ma-k0aQkg6wgHOTTN1pDK0YnON6Wlw/exec";   // replace with same Apps Script URL
const overlay = document.getElementById("overlayLoader");
const list = document.getElementById("transactionList");
const actionModal = new bootstrap.Modal(document.getElementById('actionModal'));
let selectedTx = null;

// Long press detection
let timer;
function addLongPress(el, callback){
  el.addEventListener('mousedown', () => timer = setTimeout(callback, 800));
  el.addEventListener('touchstart', () => timer = setTimeout(callback, 800));
  el.addEventListener('mouseup', () => clearTimeout(timer));
  el.addEventListener('mouseleave', () => clearTimeout(timer));
  el.addEventListener('touchend', () => clearTimeout(timer));
}

// Load transactions
async function loadTransactions(){
  overlay.style.display = "flex";
  try{
    const res = await fetch(API_URL);
    const data = await res.json();
    list.innerHTML = "";

    if(data.length===0){
      list.innerHTML = `<div class="text-center text-muted mt-5">No transactions yet</div>`;
      return;
    }

    // Group by date
    const grouped = {};
    data.forEach(t=>{
      const dateKey = new Date(t.date).toDateString();
      if(!grouped[dateKey]) grouped[dateKey]=[];
      grouped[dateKey].push(t);
    });

    Object.keys(grouped).reverse().forEach(dateKey=>{
      let incomeTotal=0, expenseTotal=0;
      grouped[dateKey].forEach(t=>{
        if(t.type==="Income") incomeTotal+=Number(t.amount);
        if(t.type==="Expense") expenseTotal+=Number(t.amount);
      });

      // Date header + summary
      list.innerHTML += `
        <div class="mb-2">
          <div class="fw-bold">${dateKey}</div>
          <div class="d-flex justify-content-between small text-muted mb-2">
            <span>Income: <span class="text-success fw-semibold">₹${incomeTotal}</span></span>
            <span>Expense: <span class="text-danger fw-semibold">₹${expenseTotal}</span></span>
          </div>
        </div>
      `;

      grouped[dateKey].forEach(t=>{
        const card = document.createElement('div');
        card.className = 'card shadow-sm border-0 mb-2';
        const badgeClass = t.type==="Income"?"bg-success":t.type==="Expense"?"bg-danger":"bg-primary";
        const amountClass = t.type==="Income"?"text-success":t.type==="Expense"?"text-danger":"text-primary";
        card.innerHTML = `
          <div class="card-body py-2 px-3">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h6 class="mb-0 fw-semibold" style="font-size:0.95rem;">${t.description}</h6>
                <small class="text-muted" style="font-size:0.75rem;">${t.category||"General"}</small>
              </div>
              <span class="badge ${badgeClass} py-1 px-2" style="font-size:0.75rem;">${t.type}</span>
            </div>
            <div class="text-end mt-1">
              <h6 class="mb-0 fw-bold ${amountClass}" style="font-size:0.95rem;">₹${t.amount}</h6>
            </div>
          </div>
        `;
        list.appendChild(card);
        addLongPress(card, ()=>{ selectedTx = t; actionModal.show(); });
      });
    });

  }catch(e){
    list.innerHTML = `<p class="text-danger text-center mt-4">Data load aagala</p>`;
  }finally{
    overlay.style.display = "none";
  }
}

// Edit button
document.getElementById('editBtn').addEventListener('click',()=>{
  actionModal.hide();
  const params = new URLSearchParams(selectedTx).toString();
  window.location.href = `add.html?${params}`;
});

// Delete button
document.getElementById('deleteBtn').addEventListener('click', async ()=>{
  if(!confirm("Are you sure to delete?")) return;
  actionModal.hide();
  try{
    await fetch(`${DELETE_URL}?id=${selectedTx.id}`);
    loadTransactions();
  }catch(err){
    alert("Delete failed");
  }
});

loadTransactions();
</script>

</body>
</html>
