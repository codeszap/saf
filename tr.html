<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trigger Upload</title>
  <link rel="stylesheet" href="css/bootstrap.min.css" />
  <style>
    #triggerTable, #triggerTable th, #triggerTable td {
      border: 1px solid #dee2e6 !important;
    }
    #triggerTable {
      border-collapse: collapse !important;
    }
  </style>
</head>
<body class="bg-light">
<div class="container my-4">

  <div class="d-flex justify-content-between mb-3">
    <h2>STC Trigger Tracker</h2>
    <input type="file" id="uploadJson" accept=".json" class="form-control w-auto" />
  </div>

  <form id="triggerForm" class="card p-4 shadow rounded">
    <div class="mb-3">
      <label for="date" class="form-label fw-semibold">Date</label>
      <input type="date" id="date" class="form-control" required />
    </div>

    <div class="mb-3">
      <label class="form-label fw-semibold">Trigger (What Happened?)</label>
      <textarea id="whathappened" rows="3" class="form-control"></textarea>
    </div>

    <div class="mb-3">
      <label class="form-label fw-semibold">What I Felt Inside</label>
      <textarea id="whatifelt" rows="3" class="form-control"></textarea>
    </div>

    <div class="mb-3">
      <label class="form-label fw-semibold">What I did</label>
      <textarea id="whatidid" rows="3" class="form-control"></textarea>
    </div>

    <div class="d-flex gap-2 justify-content-end flex-wrap">
      <button type="submit" class="btn btn-primary">Save</button>
      <button type="button" id="clearBtn" class="btn btn-danger">Clear All</button>
    </div>
  </form>

  <div class="card shadow p-3 mt-4" id="snapshotContainer">
    <table class="table table-bordered table-striped mt-3" id="triggerTable">
      <thead class="table-primary">
        <tr>
          <th>Date</th>
          <th>Trigger (What Happened?)</th>
          <th>What I Felt Inside</th>
          <th>What I Did</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  const DB_NAME = "TriggerDB";
  const STORE_NAME = "entries";
  let db;

  const form = document.getElementById('triggerForm');
  const tableBody = document.querySelector('#triggerTable tbody');
  const dateInput = document.getElementById('date');

  dateInput.valueAsDate = new Date();

  function openDB() {
    const request = indexedDB.open(DB_NAME, 1);
    request.onerror = () => alert("❌ Failed to open DB");
    request.onsuccess = (e) => {
      db = e.target.result;
      loadEntries();
    };
    request.onupgradeneeded = (e) => {
      db = e.target.result;
      db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
    };
  }

  function addEntry(entry) {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    tx.objectStore(STORE_NAME).add(entry);
    tx.oncomplete = () => {
      loadEntries();
      form.reset();
      dateInput.valueAsDate = new Date();
    };
  }

  function loadEntries() {
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    const entries = [];

    store.openCursor().onsuccess = (e) => {
      const cursor = e.target.result;
      if (cursor) {
        entries.push(cursor.value);
        cursor.continue();
      } else {
        tableBody.innerHTML = '';
        entries.forEach(entry => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${entry.date}</td>
            <td>${entry.whathappened}</td>
            <td>${entry.whatifelt}</td>
            <td>${entry.whatidid}</td>
          `;
          tableBody.appendChild(row);
        });
      }
    };
  }

  form.addEventListener('submit', function (e) {
    e.preventDefault();
    const dateVal = dateInput.value.split('-').reverse().join('-');
    const whathappened = document.getElementById('whathappened').value;
    const whatifelt = document.getElementById('whatifelt').value;
    const whatidid = document.getElementById('whatidid').value;
    addEntry({ date: dateVal, whathappened, whatifelt, whatidid });
  });

  document.getElementById('clearBtn').addEventListener('click', () => {
    if (confirm("Clear all entries?")) {
      const tx = db.transaction(STORE_NAME, 'readwrite');
      tx.objectStore(STORE_NAME).clear().onsuccess = loadEntries;
    }
  });

  document.getElementById('uploadJson').addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (event) {
      try {
        const parsed = JSON.parse(event.target.result);
        const entries = parsed.data || [];

        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        store.clear().onsuccess = () => {
          entries.forEach(entry => store.add(entry));
          setTimeout(loadEntries, 500);
        };
      } catch (err) {
        alert("❌ Failed to parse JSON");
      }
    };
    reader.readAsText(file);
  });

  window.onload = openDB;
</script>
</body>
</html>
