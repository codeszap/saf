<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>STC Trigger Tracker</title>
  <link rel="stylesheet" href="css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    #triggerTable, #triggerTable th, #triggerTable td {
      border: 1px solid #dee2e6 !important;
    }
    #triggerTable {
      border-collapse: collapse !important;
    }
  </style>
</head>
<body class="bg-light">

<div class="container my-4">
  <form id="triggerForm" class="card p-4 shadow rounded">
    <div class="mb-3">
      <label for="date" class="form-label fw-semibold">Date</label>
      <input type="date" id="date" class="form-control" required />
    </div>
    <div class="mb-3">
      <label class="form-label fw-semibold">Trigger (What Happened?)</label>
      <textarea id="whathappened" rows="3" class="form-control"></textarea>
    </div>
    <div class="mb-3">
      <label class="form-label fw-semibold">What I Felt Inside</label>
      <textarea id="whatifelt" rows="3" class="form-control"></textarea>
    </div>
    <div class="mb-3">
      <label class="form-label fw-semibold">What I did</label>
      <textarea id="whatidid" rows="3" class="form-control"></textarea>
    </div>
    <div class="d-flex gap-2 justify-content-end flex-wrap">
      <button type="submit" class="btn btn-primary">Save</button>
      <button type="button" id="clearBtn" class="btn btn-danger">Clear</button>
      <button type="button" id="downloadImgBtn" class="btn btn-success">📸 Download</button>
      <button type="button" id="downloadJsonBtn" class="btn btn-warning">💾 Download JSON</button>
    </div>
  </form>

  <div class="card shadow p-3 mt-5" id="snapshotContainer">
    <div class="table-responsive">
      <h2 class="text-center mb-4">Reactions Tracker - Confident Professional</h2>
      <table class="table table-bordered table-hover table-striped align-middle text-nowrap" id="triggerTable">
        <thead class="table-primary">
          <tr>
            <th>Date</th>
            <th>Trigger (What Happened?)</th>
            <th>What I Felt Inside</th>
            <th>What I did</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Context Menu -->
<div id="contextMenu" class="position-absolute bg-white border shadow-sm rounded d-none z-3">
  <button class="dropdown-item" id="editRow">📝 Edit</button>
  <button class="dropdown-item" id="deleteRow">🗑️ Delete</button>
  <button class="dropdown-item" id="cancelMenu">❌ Cancel</button>
</div>

<script>
  const DB_NAME = "TriggerDB";
  const STORE_NAME = "entries";
  let db;
  let selectedRowId = null;

  const dateInput = document.getElementById('date');
  const form = document.getElementById('triggerForm');
  const tableBody = document.querySelector('#triggerTable tbody');
  const contextMenu = document.getElementById('contextMenu');

  dateInput.valueAsDate = new Date();

  function openDB() {
    const request = indexedDB.open(DB_NAME, 1);
    request.onerror = () => alert("Failed to open DB");
    request.onsuccess = (e) => {
      db = e.target.result;
      loadEntries();
    };
    request.onupgradeneeded = (e) => {
      db = e.target.result;
      db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
    };
  }

  function addEntry(entry) {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    tx.objectStore(STORE_NAME).add(entry);
    tx.oncomplete = () => {
      loadEntries();
      form.reset();
      dateInput.valueAsDate = new Date();
    };
  }

  function loadEntries() {
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    const entries = [];

    store.openCursor().onsuccess = (e) => {
      const cursor = e.target.result;
      if (cursor) {
        entries.push(cursor.value);
        cursor.continue();
      } else {
        tableBody.innerHTML = '';
        entries.forEach(entry => {
          const row = document.createElement('tr');
          row.dataset.id = entry.id;
          row.innerHTML = `
            <td>${entry.date}</td>
            <td>${entry.whathappened}</td>
            <td>${entry.whatifelt}</td>
            <td>${entry.whatidid}</td>
          `;
          row.addEventListener('contextmenu', function (e) {
            e.preventDefault();
            selectedRowId = entry.id;
            contextMenu.style.top = `${e.pageY}px`;
            contextMenu.style.left = `${e.pageX}px`;
            contextMenu.classList.remove("d-none");
          });
          tableBody.appendChild(row);
        });
      }
    };
  }

  form.addEventListener('submit', function (e) {
    e.preventDefault();
    const dateVal = dateInput.value.split('-').reverse().join('-');
    const whathappened = document.getElementById('whathappened').value;
    const whatifelt = document.getElementById('whatifelt').value;
    const whatidid = document.getElementById('whatidid').value;
    addEntry({ date: dateVal, whathappened, whatifelt, whatidid });
  });

  document.getElementById('clearBtn').addEventListener('click', () => {
    if (confirm("Clear all entries?")) {
      const tx = db.transaction(STORE_NAME, 'readwrite');
      tx.objectStore(STORE_NAME).clear();
      tx.oncomplete = loadEntries;
    }
  });

  document.getElementById('downloadImgBtn').addEventListener('click', () => {
    const snapshot = document.getElementById('snapshotContainer');
    html2canvas(snapshot).then(canvas => {
      const base64Image = canvas.toDataURL("image/png");
      if (window.ImageChannel && window.ImageChannel.postMessage) {
        window.ImageChannel.postMessage(base64Image);
      } else {
        const link = document.createElement('a');
        link.download = 'trigger_log.png';
        link.href = base64Image;
        link.click();
      }
    });
  });

  document.getElementById('downloadJsonBtn').addEventListener('click', () => {
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    const entries = [];

    store.openCursor().onsuccess = (e) => {
      const cursor = e.target.result;
      if (cursor) {
        entries.push(cursor.value);
        cursor.continue();
      } else {
        const payload = {
          form: 'trigger_form',
          data: entries
        };
        if (window.SaveDataChannel && window.SaveDataChannel.postMessage) {
          window.SaveDataChannel.postMessage(JSON.stringify(payload));
        } else {
          const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = 'trigger_form.json';
          link.click();
        }
      }
    };
  });

  document.getElementById('editRow').addEventListener('click', () => {
    if (!selectedRowId) return;
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    store.get(selectedRowId).onsuccess = function (e) {
      const entry = e.target.result;
      const [d, m, y] = entry.date.split('-');
      dateInput.value = `${y}-${m}-${d}`;
      document.getElementById('whathappened').value = entry.whathappened;
      document.getElementById('whatifelt').value = entry.whatifelt;
      document.getElementById('whatidid').value = entry.whatidid;
      store.delete(selectedRowId).onsuccess = loadEntries;
      contextMenu.classList.add("d-none");
    };
  });

  document.getElementById('deleteRow').addEventListener('click', () => {
    if (!selectedRowId) return;
    if (confirm("Delete this entry?")) {
      const tx = db.transaction(STORE_NAME, 'readwrite');
      tx.objectStore(STORE_NAME).delete(selectedRowId).onsuccess = loadEntries;
    }
    contextMenu.classList.add("d-none");
  });

  document.getElementById('cancelMenu').addEventListener('click', () => {
    contextMenu.classList.add("d-none");
  });

  document.addEventListener('click', (e) => {
    if (!contextMenu.contains(e.target)) {
      contextMenu.classList.add("d-none");
    }
  });

  window.onload = openDB;
</script>

</body>
</html>
