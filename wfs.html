<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Daily Food Tracker - Card Image Download</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
  body { padding: 15px; }
  .card { border: 1px solid #ddd; margin-bottom: 10px; border-radius: 0.5rem; padding: 0; }
  .card-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; padding: 10px 15px; background-color: #f8f9fa; border-bottom: 1px solid #ddd; border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; }
  .card-body { display: none; padding: 10px 15px; background-color: #fff; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }
</style>
</head>
<body>

<div class="container">
  <h2 class="mb-4">Daily Food Tracker</h2>

  <!-- Form -->
  <form id="foodForm" class="mb-4">
    <div class="row g-2">
      <div class="col-6 col-md-3">
        <input type="date" id="date" class="form-control" required>
      </div>
      <div class="col-6 col-md-3">
        <input type="text" id="foodName" class="form-control" placeholder="Food Name" required>
      </div>
      <div class="col-12 col-md-4">
        <input type="text" id="ingredients" class="form-control" placeholder="Ingredients (comma separated)" required>
      </div>
      <div class="col-12 col-md-2">
        <input type="text" id="notes" class="form-control" placeholder="Notes">
      </div>
    </div>
    <button type="submit" class="btn btn-primary mt-3">Save</button>
  </form>

  <!-- Summary -->
  <div id="summary" class="alert alert-info">Total Days: 0 | Total Foods: 0</div>

  <!-- Cards container (used for snapshot) -->
  <div id="cardContainer" style="background:#f0f0f0; padding:10px; border-radius:0.5rem;"></div>

  <!-- Action buttons -->
  <div class="my-3">
    <button id="downloadImage" class="btn btn-info btn-sm">ðŸ“¸ Download as Image</button>
    <button id="downloadJSON" class="btn btn-warning btn-sm">ðŸ’¾ Download JSON</button>
    <input type="file" id="importJSON" class="form-control-sm" accept=".json">
  </div>
</div>

<!-- Long Press Modal -->
<div class="modal fade" id="longPressModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Select Action</h5></div>
      <div class="modal-body">
        <button id="editBtn" class="btn btn-primary w-100 mb-2">Edit</button>
        <button id="deleteBtn" class="btn btn-danger w-100 mb-2">Delete</button>
        <button class="btn btn-secondary w-100" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
let foodData = [];
let longPressTimer;
let selectedRowIndex = null;

// IndexedDB setup
const dbName = "foodTrackerDB";
let db;
const request = indexedDB.open(dbName, 1);
request.onupgradeneeded = e => {
  db = e.target.result;
  db.createObjectStore("foods", { keyPath: "id", autoIncrement: true });
};
request.onsuccess = e => { db = e.target.result; loadFromDB(); };
request.onerror = e => console.error("DB error:", e.target.error);

function saveToDB() {
  const tx = db.transaction("foods", "readwrite");
  const store = tx.objectStore("foods");
  store.clear();
  foodData.forEach(item => store.add(item));
}

function loadFromDB() {
  const tx = db.transaction("foods", "readonly");
  const store = tx.objectStore("foods");
  store.getAll().onsuccess = e => {
    foodData = e.target.result;
    renderCards();
  };
}

function formatDate(isoDate) {
  const [y, m, d] = isoDate.split("-");
  return `${d}-${m}-${y}`;
}

// Save form
document.getElementById("foodForm").addEventListener("submit", e => {
  e.preventDefault();
  const date = document.getElementById("date").value;
  const name = document.getElementById("foodName").value;
  const ingr = document.getElementById("ingredients").value;
  const note = document.getElementById("notes").value;

  if (selectedRowIndex !== null) {
    foodData[selectedRowIndex] = { date, foodName: name, ingredients: ingr, notes: note };
    selectedRowIndex = null;
  } else {
    foodData.push({ date, foodName: name, ingredients: ingr, notes: note });
  }
  saveToDB();
  renderCards();
  e.target.reset();
});

// Render cards
function renderCards() {
  const container = document.getElementById("cardContainer");
  container.innerHTML = "";
  foodData.forEach((item, index) => {
    const card = document.createElement("div");
    card.className = "card";

    const header = document.createElement("div");
    header.className = "card-header";
    header.innerHTML = `<span>${item.foodName}</span><span>${formatDate(item.date)}</span>`;

    const body = document.createElement("div");
    body.className = "card-body";
    const ingredientList = item.ingredients
      .split(",")
      .map(ing => `<li>${ing.trim()}</li>`)
      .join("");
    body.innerHTML = `<p><strong>Ingredients:</strong></p><ul>${ingredientList}</ul><p><strong>Notes:</strong> ${item.notes || ""}</p>`;

    // Long press detection
    card.addEventListener("mousedown", e => {
      e.stopPropagation();
      longPressTimer = setTimeout(() => {
        selectedRowIndex = index;
        new bootstrap.Modal(document.getElementById("longPressModal")).show();
      }, 600);
    });
    card.addEventListener("mouseup", () => clearTimeout(longPressTimer));
    card.addEventListener("mouseleave", () => clearTimeout(longPressTimer));

    // Tap to expand/collapse
    header.addEventListener("click", e => {
      e.stopPropagation();
      body.style.display = body.style.display === "none" ? "block" : "none";
    });

    card.appendChild(header);
    card.appendChild(body);
    container.appendChild(card);
  });
  updateSummary();
}

// Summary
function updateSummary() {
  const days = new Set(foodData.map(item => item.date)).size;
  document.getElementById("summary").textContent = `Total Days: ${days} | Total Foods: ${foodData.length}`;
}

// Edit/Delete actions
document.getElementById("editBtn").addEventListener("click", () => {
  const item = foodData[selectedRowIndex];
  document.getElementById("date").value = item.date;
  document.getElementById("foodName").value = item.foodName;
  document.getElementById("ingredients").value = item.ingredients;
  document.getElementById("notes").value = item.notes;
  bootstrap.Modal.getInstance(document.getElementById("longPressModal")).hide();
});

document.getElementById("deleteBtn").addEventListener("click", () => {
  foodData.splice(selectedRowIndex, 1);
  saveToDB();
  renderCards();
  bootstrap.Modal.getInstance(document.getElementById("longPressModal")).hide();
});

// Download Image
document.getElementById("downloadImage").addEventListener("click", () => {
  const snapshot = document.getElementById("cardContainer");
  if(snapshot.children.length === 0){ alert("No data to download"); return; }

  // Clone to keep styling and spacing
  const clone = snapshot.cloneNode(true);
  Object.assign(clone.style, {
    backgroundColor: "#f0f0f0",
    padding: "10px",
    borderRadius: "0.5rem",
    display: "block"
  });
  const hiddenContainer = document.createElement("div");
  Object.assign(hiddenContainer.style, { position: 'fixed', top: '-9999px', left: '-9999px' });
  hiddenContainer.appendChild(clone);
  document.body.appendChild(hiddenContainer);

  html2canvas(clone, { backgroundColor: "#fff", scale: 2 }).then(canvas => {
    const link = document.createElement("a");
    link.href = canvas.toDataURL("image/png");
    link.download = "food_cards.png";
    link.click();
  }).finally(() => {
    document.body.removeChild(hiddenContainer);
  });
});

// Download JSON
document.getElementById("downloadJSON").addEventListener("click", () => {
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(foodData));
  const a = document.createElement("a");
  a.href = dataStr;
  a.download = "food_data.json";
  a.click();
});

// Import JSON
document.getElementById("importJSON").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = evt => {
    try {
      const imported = JSON.parse(evt.target.result);
      if (Array.isArray(imported)) {
        foodData = imported;
        saveToDB();
        renderCards();
      }
    } catch (err) {
      alert("Invalid JSON file");
    }
  };
  reader.readAsText(file);
});
</script>

</body>
</html>
